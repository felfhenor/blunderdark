# Ralph Progress Log
Started: Mon, Feb  2, 2026  2:24:22 PM
---

## resource-manager US-001: Define Resource Types and State [DONE]
- Created `src/app/interfaces/resource.ts` with `ResourceType`, `ResourceState`, and `ResourceMap` types
- Expanded `gamedata/currency/base.yml` with all 7 resource types (crystals, food, gold, flux, research, essence, corruption) including UUIDs and default max values
- Added resource export to interfaces barrel file
- All tests pass (66/66), no new typecheck errors
- Commit: 27f7f8a

## resource-manager US-002: Resource State Signal [DONE]
- Created `src/app/helpers/resources.ts` with `getResource(type)` and `allResources()` computed signal accessors
- Added `resources: ResourceMap` field to `GameStateWorld` interface in `src/app/interfaces/state-game.ts`
- Added `defaultResources()` factory to `src/app/helpers/defaults.ts` with starting values matching currency YAML (all start at 0 current)
- Updated `worldgenGenerateWorld()` in `worldgen.ts` to include default resources
- Exported resources helper from barrel file
- All tests pass (66/66), lint passes, no new typecheck errors
- Commit: 0b26811

## resource-manager US-003: Add Resources with Cap Validation [DONE]
- Added `addResource(type, amount)` function to `src/app/helpers/resources.ts`
- Returns the actual amount added after capping at max; rejects negative amounts
- Created `src/app/helpers/resources.spec.ts` with 6 unit tests covering: normal add, add exceeding cap, add zero, add negative, resource already at max, different resource types
- All tests pass (72/72), lint passes, no new typecheck errors
- Commit: a3c044c

## resource-manager US-004: Subtract Resources with Floor Validation [DONE]
- Added `ResourceCost` type to `src/app/interfaces/resource.ts` as `Partial<Record<ResourceType, number>>`
- Added `subtractResource(type, amount)` to `src/app/helpers/resources.ts` — returns false if would go below 0, no partial subtraction
- Added `canAfford(costs)` — checks if all costs in a `ResourceCost` can be paid
- Added `payCost(costs)` — atomically subtracts multiple resources (all-or-nothing via canAfford check before update)
- Added 10 unit tests covering: normal subtract, subtract more than available, subtract zero, subtract negative, exact amount, canAfford true/false/empty, payCost success, payCost failure
- All tests pass (82/82), lint passes, no new typecheck errors
- Commit: b59eb52

## resource-manager US-005: Resource Change Callbacks [DONE]
- Added `isResourceLow(type, threshold)` computed signal to `src/app/helpers/resources.ts` — returns true when current/max is below threshold percentage
- Added `isResourceFull(type)` computed signal — returns true when current equals max
- Added 8 unit tests covering: low below/above threshold, low at zero, low reactivity, full at max, full below max, full at zero, full reactivity
- All tests pass (90/90), lint passes, no new typecheck errors
- Commit: e580da0

## resource-manager US-006: Resource Save and Load [DONE]
- Added `migrateResources(saved)` to `src/app/helpers/resources.ts` — takes a partial ResourceMap from saved state and fills missing resource types with defaults
- Updated `src/app/helpers/migrate.ts` to call `migrateResources()` during game state migration, ensuring new resource types added in updates get initialized
- Added 4 unit tests covering: round-trip preservation, missing resource initialization, empty saved state, input immutability
- All tests pass (94/94), lint passes, no new typecheck errors
- **Learnings for future iterations:**
  - `migrateGameState()` uses `merge()` from es-toolkit for general field migration, but resource migration needs explicit handling since `merge()` alone doesn't guarantee the full ResourceMap shape
  - The `indexedDbSignal` in signal.ts auto-persists on `set()`/`update()` — no manual save needed for normal operations
  - Resource persistence is already wired via `GameStateWorld.resources` field added in US-002
- Commit: a78cb81
