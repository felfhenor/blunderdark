# Ralph Progress Log
Started: Mon, Feb  2, 2026  2:24:22 PM
---

## resource-manager US-001: Define Resource Types and State [DONE]
- Created `src/app/interfaces/resource.ts` with `ResourceType`, `ResourceState`, and `ResourceMap` types
- Expanded `gamedata/currency/base.yml` with all 7 resource types (crystals, food, gold, flux, research, essence, corruption) including UUIDs and default max values
- Added resource export to interfaces barrel file
- All tests pass (66/66), no new typecheck errors
- Commit: 27f7f8a

## resource-manager US-002: Resource State Signal [DONE]
- Created `src/app/helpers/resources.ts` with `getResource(type)` and `allResources()` computed signal accessors
- Added `resources: ResourceMap` field to `GameStateWorld` interface in `src/app/interfaces/state-game.ts`
- Added `defaultResources()` factory to `src/app/helpers/defaults.ts` with starting values matching currency YAML (all start at 0 current)
- Updated `worldgenGenerateWorld()` in `worldgen.ts` to include default resources
- Exported resources helper from barrel file
- All tests pass (66/66), lint passes, no new typecheck errors
- Commit: 0b26811

## resource-manager US-003: Add Resources with Cap Validation [DONE]
- Added `addResource(type, amount)` function to `src/app/helpers/resources.ts`
- Returns the actual amount added after capping at max; rejects negative amounts
- Created `src/app/helpers/resources.spec.ts` with 6 unit tests covering: normal add, add exceeding cap, add zero, add negative, resource already at max, different resource types
- All tests pass (72/72), lint passes, no new typecheck errors
- Commit: a3c044c

## resource-manager US-004: Subtract Resources with Floor Validation [DONE]
- Added `ResourceCost` type to `src/app/interfaces/resource.ts` as `Partial<Record<ResourceType, number>>`
- Added `subtractResource(type, amount)` to `src/app/helpers/resources.ts` — returns false if would go below 0, no partial subtraction
- Added `canAfford(costs)` — checks if all costs in a `ResourceCost` can be paid
- Added `payCost(costs)` — atomically subtracts multiple resources (all-or-nothing via canAfford check before update)
- Added 10 unit tests covering: normal subtract, subtract more than available, subtract zero, subtract negative, exact amount, canAfford true/false/empty, payCost success, payCost failure
- All tests pass (82/82), lint passes, no new typecheck errors
- Commit: b59eb52

## resource-manager US-005: Resource Change Callbacks [DONE]
- Added `isResourceLow(type, threshold)` computed signal to `src/app/helpers/resources.ts` — returns true when current/max is below threshold percentage
- Added `isResourceFull(type)` computed signal — returns true when current equals max
- Added 8 unit tests covering: low below/above threshold, low at zero, low reactivity, full at max, full below max, full at zero, full reactivity
- All tests pass (90/90), lint passes, no new typecheck errors
- Commit: e580da0

## resource-manager US-006: Resource Save and Load [DONE]
- Added `migrateResources(saved)` to `src/app/helpers/resources.ts` — takes a partial ResourceMap from saved state and fills missing resource types with defaults
- Updated `src/app/helpers/migrate.ts` to call `migrateResources()` during game state migration, ensuring new resource types added in updates get initialized
- Added 4 unit tests covering: round-trip preservation, missing resource initialization, empty saved state, input immutability
- All tests pass (94/94), lint passes, no new typecheck errors
- **Learnings for future iterations:**
  - `migrateGameState()` uses `merge()` from es-toolkit for general field migration, but resource migration needs explicit handling since `merge()` alone doesn't guarantee the full ResourceMap shape
  - The `indexedDbSignal` in signal.ts auto-persists on `set()`/`update()` — no manual save needed for normal operations
  - Resource persistence is already wired via `GameStateWorld.resources` field added in US-002
- Commit: a78cb81

## inhabitant-data-model US-001: Define InhabitantDefinition, InhabitantStats, and InhabitantTrait types [DONE]
- Created `src/app/interfaces/inhabitant.ts` with `InhabitantTrait`, `InhabitantStats`, `InhabitantDefinition` types
- `InhabitantDefinition.cost` uses `Partial<Record<ResourceType, number>>` to match `ResourceCost`
- `InhabitantStats` includes: hp, attack, defense, speed, workerEfficiency
- Exported via barrel at `@interfaces`
- All tests pass (94/94), lint passes, no new typecheck errors
- **Learnings:** Interfaces directory uses `@interfaces/resource` alias for internal imports (lint rule: `typescript-paths/absolute-import`)
- Commit: 9e5a466

## inhabitant-data-model US-002: Define InhabitantInstance and conditional states [DONE]
- Added `InhabitantState` union type (`'normal' | 'scared' | 'hungry'`) to `src/app/interfaces/inhabitant.ts`
- Added `InhabitantInstance` type with instanceId, definitionId, name, state, assignedRoomId
- Added `inhabitants: InhabitantInstance[]` to `GameStateWorld` in `src/app/interfaces/state-game.ts`
- Updated `defaultGameState()` in `src/app/helpers/defaults.ts` to include `inhabitants: []`
- All tests pass (94/94), lint passes, no new typecheck errors
- Commit: 4c26b3b

## inhabitant-data-model US-003: Define Tier 1 inhabitants in YAML gamedata [DONE]
- Populated `gamedata/inhabitant/base.yml` with 5 Tier 1 inhabitants: Goblin, Kobold, Skeleton, Myconid, Slime
- Each entry has: UUID, name, type, tier, description, cost, stats, traits matching `InhabitantDefinition` type
- Goblin: Miner trait (+20% crystals), Kobold: Trapper trait, Skeleton: Guardian trait, Myconid: Farmer trait (+15% food), Slime: Adaptable trait
- YAML compiles via `npm run gamedata:build` — 5 entries loaded, JSON generated
- **Learnings:** `public/json/` is gitignored (generated output), only commit YAML source files. Other empty YAML files (room, decoration, pet, invader) cause non-fatal "doc is not iterable" errors in the build script — pre-existing issue.
- Commit: 176ab28

## inhabitant-data-model US-004: Implement inhabitant serialization for save/load [DONE]
- Created `src/app/helpers/inhabitants.ts` with: `allInhabitants()`, `getInhabitant()`, `addInhabitant()`, `removeInhabitant()`, `serializeInhabitants()`, `deserializeInhabitants()`
- `deserializeInhabitants()` handles missing optional fields (defaults state to 'normal', assignedRoomId to null)
- Created `src/app/helpers/inhabitants.spec.ts` with 9 unit tests covering: add, remove, get all, get by id, get nonexistent, round-trip single, round-trip multiple, missing fields, immutability
- All tests pass (103/103), lint passes, no new typecheck errors
- Commit: 639c6af

## tetromino-room-shapes US-001: Define RoomShape Type [DONE]
- Created `src/app/interfaces/room-shape.ts` with `TileOffset`, `RoomShape` types
- `RoomShape` has: id, name, tiles (array of `{x, y}` relative coordinates), width, height
- Exported via barrel at `@interfaces`
- Commit: 11d68c5

## tetromino-room-shapes US-002: Define Shape Variants in Gamedata YAML [DONE]
- Created `gamedata/roomshape/base.yml` with 6 shapes: Square 2x2, Square 3x3, Square 4x4, L-Shape, T-Shape, I-Shape
- Each shape has UUID, name, width, height, and relative tile coordinates
- Compiles via `npm run gamedata:build` — 6 entries loaded
- **Learnings:** Created separate `gamedata/roomshape/` folder rather than putting in `gamedata/room/` to avoid mixing with future room definitions (build script merges all files per folder)
- Commit: 2effb63

## tetromino-room-shapes US-003: Load Room Shapes via ContentService [DONE]
- Added `'roomshape'` to `ContentType` union in `src/app/interfaces/identifiable.ts`
- Added `ensureRoomShape` initializer in `src/app/helpers/content-initializers.ts`
- Created `src/app/helpers/room-shapes.ts` with `allRoomShapes()` and `getRoomShape()` content accessors
- **Learnings:** ContentType union must include the type for the initializer to work; `ensureContent()` is called during `unfurlAssets()` and crashes if the type is not registered
- Commit: 318a764

## tetromino-room-shapes US-004: RoomShape Helper Functions [DONE]
- Added `getAbsoluteTiles(shape, anchorX, anchorY)` — converts relative tiles to absolute grid coordinates
- Added `getShapeBounds(shape)` — returns width/height bounding box from tiles
- Added `shapeFitsInGrid(shape, anchorX, anchorY, gridSize)` — checks all tiles within grid bounds
- Created `src/app/helpers/room-shapes.spec.ts` with 16 unit tests covering all helpers
- All tests pass (119/119), lint passes
- Commit: 05e25e3

## tetromino-room-shapes US-005: Shape Serialization for Save/Load [DONE]
- Added `PlacedRoom` type to `src/app/interfaces/room-shape.ts` with: id, shapeId, anchorX, anchorY
- Added `resolveRoomShape(placedRoom)` — resolves shape from content by shapeId, returns 1x1 fallback if not found
- Added 3 tests: JSON round-trip, shapeId-not-full-data verification, fallback on missing shape
- All tests pass (122/122), lint passes
- Commit: 485e96a

## grid-system US-001 through US-005: All Stories [DONE]
- All grid-system user stories were already implemented in prior work
- US-001: `GridTile`, `GridState` types and `GRID_SIZE` constant in `src/app/interfaces/grid.ts`
- US-002: `createEmptyGrid`, `isInBounds`, `getTile`, `setTile`, `resetGrid` in `src/app/helpers/grid.ts` with 15 unit tests in `grid.spec.ts`
- US-003: `GridComponent` (OnPush) in `src/app/components/grid/` with 20x20 CSS grid layout, `.occupied`/`.selected` classes, rendered on game-play page
- US-004: `selectedTile` signal, `selectTile`/`deselectTile` helpers, Escape key handler via host binding, hover and selected CSS styles
- US-005: `GridState` in `GameStateWorld`, JSON round-trip test, `createEmptyGrid()` used in `defaults.ts` for new games
- All tests pass (122/122), lint passes
- **Learnings for future iterations:**
  - Grid helpers use pure functions (take grid as param, return new grid) rather than signal-based mutation — consistent immutable pattern
  - `GameStateWorld` already includes `grid: GridState` — no migration needed
  - Grid component uses `(document:keydown.escape)` in host bindings for keyboard shortcuts
  - CSS uses `var(--b3)`, `var(--p)`, `var(--s)`, `var(--pf)` theme variables from DaisyUI

## room-placement-validation US-001 through US-003: Validation Functions [DONE]
- Created `src/app/helpers/room-placement.ts` with three validation functions:
  - `validateBounds(shape, anchorX, anchorY, gridSize)` — returns `{valid, error?}`
  - `validateNoOverlap(shape, anchorX, anchorY, grid)` — returns `{valid, error?, conflictingTiles?}`
  - `validatePlacement(shape, anchorX, anchorY, grid)` — combined check returning `{valid, errors: string[]}`
- Created `src/app/helpers/room-placement.spec.ts` with 17 unit tests covering bounds edges, overlap scenarios, and combined validation
- All tests pass (139/139), lint passes
- Commit: cd57d94
- **Learnings for future iterations:**
  - Lint rule `typescript-paths/absolute-import` requires `@helpers/room-placement` not `./room-placement` in test imports
  - `getAbsoluteTiles()` from room-shapes.ts is reusable for converting shape-relative tiles to grid-absolute coordinates
  - Grid tiles use `[y][x]` indexing (row-major) — be careful with coordinate order

## hallway-data-structure US-001 through US-004: All Stories [DONE]
- Created `src/app/interfaces/hallway.ts` with `Hallway` and `HallwayUpgrade` types
- Added `TileOccupant` union (`'empty' | 'room' | 'hallway'`) and `hallwayId` field to `GridTile`
- Added `hallways: Hallway[]` to `GameStateWorld` in state-game.ts
- Created `src/app/helpers/hallways.ts` with: `addHallwayToGrid`, `removeHallwayFromGrid`, `isTileBlockedForHallway`, `getHallwaysBetween`, `addHallway`, `removeHallway`, `addUpgradeToHallway`, `removeUpgradeFromHallway`, `serializeHallways`, `deserializeHallways`
- Created `src/app/helpers/hallways.spec.ts` with 17 unit tests
- All tests pass (156/156), lint passes
- Commit: 3ce7f87
- **Learnings for future iterations:**
  - When adding new fields to `GridTile`, update `createEmptyGrid()` in grid.ts and fix any `toEqual` assertions in grid.spec.ts
  - Hallway helpers follow the same pure-function pattern as grid helpers (take state in, return new state)
  - `removeHallwayFromGrid` checks `hallwayId` matches before clearing — prevents accidental deletion of overlapping structures

## seasonal-cycle-system US-001 through US-005: Data Layer Complete [DONE]
- Created `src/app/interfaces/season.ts` with `Season` union, `SeasonState`, `SEASON_ORDER`, `DAYS_PER_SEASON`
- Created `src/app/helpers/season.ts` with: `advanceDay()` pure function, `advanceGameDay()` signal updater, computed signals (`currentSeason`, `dayInSeason`, `seasonProgress`, `totalSeasonCycles`), `isSeason()` helper, `getSeasonLabel()`, `seasonTransition$` RxJS observable
- Added `SeasonState` to `GameStateWorld`, `defaultSeasonState()` to defaults.ts
- Created `src/app/helpers/season.spec.ts` with 10 unit tests
- All tests pass (166/166), lint passes
- Commit: fe6e770
- **Learnings for future iterations:**
  - `advanceDay()` is a pure function for testability; `advanceGameDay()` wraps it with signal updates
  - Season transition event uses RxJS Subject (same pattern as notify.ts) — fires only on actual season change
  - `seasonProgress` computes percentage as `(dayInSeason - 1) / DAYS_PER_SEASON * 100` (day 1 = 0%, day 7 = ~85.7%)

## biome-system US-001: Define Biome Types [DONE]
- Created `src/app/interfaces/biome.ts` with `BiomeType` union (volcanic, flooded, crystal, corrupted, fungal, neutral), `Biome` type, and `BIOME_DATA` constant
- Commit: 1663833

## floor-creation-system US-001: Define Floor Data Model [DONE]
- Created `src/app/interfaces/floor.ts` with `Floor` type (id, name, depth, biome, grid, rooms, hallways, inhabitants) and `MAX_FLOORS` constant
- Floor type integrates BiomeType, GridState, PlacedRoom, Hallway, and InhabitantInstance
- Commit: 2e33c27
- **Learnings for future iterations:**
  - Floor type references all major game state subtypes — a good integration point
  - The current GameStateWorld has a single grid/hallways/inhabitants; multi-floor will require refactoring to use Floor[] instead

## research-tree-data-structure US-001, US-002: Types and State [DONE]
- Created `src/app/interfaces/research.ts` with `ResearchBranch`, `ResearchNode`, `ResearchTree`, `ResearchState`
- Added `ResearchState` to `GameStateWorld`, `defaultResearchState()` to defaults.ts
- Cost uses existing `ResourceCost` type from resource.ts
- All tests pass (166/166), lint passes
- Commit: 232d244
- **Learnings for future iterations:**
  - `ResearchNode.cost` reuses `ResourceCost` (Partial<Record<ResourceType, number>>) — good for consistency across systems
  - `ResearchState.activeResearchProgress` is 0-1 float, not percentage — convert for UI display

## reputation-tracking US-001, US-002: Types and State Management [DONE]
- Created `src/app/interfaces/reputation.ts` with `ReputationType`, `ReputationLevel`, `ReputationState`, `REPUTATION_THRESHOLDS`
- Created `src/app/helpers/reputation.ts` with: `addReputation`, `getReputation`, `getReputationLevel`, `resetReputation`, `getReputationLevelLabel`
- Added `ReputationState` to `GameStateWorld`, `defaultReputationState()` to defaults.ts
- Created `src/app/helpers/reputation.spec.ts` with 17 unit tests
- All tests pass (183/183), lint passes
- Commit: bace3b3
- **Learnings for future iterations:**
  - Reputation uses pure functions taking state as input (not signal-based) — consistent with grid/hallway pattern
  - `addReputation` floors at 0 with `Math.max(0, ...)` to prevent negative reputation
  - Threshold lookup descends from highest to lowest — order matters in `getReputationLevel`

## adjacency-detection US-001 through US-005: All Stories [DONE]
- Created `src/app/helpers/adjacency.ts` with full adjacency detection system:
  - `areRoomsAdjacent(tilesA, tilesB)` — pure function checking edge-sharing (horizontal/vertical, not diagonal)
  - `getSharedEdges(tilesA, tilesB)` — returns all tile pairs that share an edge
  - `AdjacencyMap` type (`Record<string, string[]>`) — JSON-serializable cache
  - `createAdjacencyMap()` — factory for empty map
  - `addRoomToAdjacencyMap(map, roomId, roomTiles, allRooms)` — incremental update on room placement
  - `removeRoomFromAdjacencyMap(map, roomId)` — cleanup on room removal
  - `getAdjacentRooms(map, roomId)` — O(1) query API
- Created `src/app/helpers/adjacency.spec.ts` with 18 unit tests covering:
  - Horizontal, vertical, diagonal, and non-touching adjacency
  - Left/above adjacency directions
  - Multi-tile room adjacency
  - Shared edge detection with single and multiple edges
  - AdjacencyMap CRUD operations
  - Query API edge cases
- All tests pass (201/201), lint passes
- Commit: d146410
- **Learnings for future iterations:**
  - `AdjacencyMap` uses `Record<string, string[]>` instead of `Map<string, Set<string>>` for JSON serialization compatibility
  - `areRoomsAdjacent` uses a Set for O(1) neighbor lookup, iterating through tilesA and checking 4 neighbors each
  - The adjacency map is bidirectional — when A is adjacent to B, both entries are updated

## reputation-tracking US-003: Map Game Actions to Reputation Points [DONE]
- Created `src/app/interfaces/reputation.ts` `ReputationAction` type with id, name, description, reputationRewards
- Added `'reputationaction'` to `ContentType` union in `src/app/interfaces/identifiable.ts`
- Added `ensureReputationAction` initializer to `src/app/helpers/content-initializers.ts`
- Created `gamedata/reputationaction/base.yml` with 15 distinct actions across all 5 reputation types:
  - Terror (3): Place Torture Chamber, Defeat Invader, Summon Wraith
  - Wealth (3): Build Treasure Vault, Complete Trade Deal, Mine Gold Vein
  - Knowledge (3): Complete Research, Build Library, Discover Ancient Artifact
  - Harmony (3): Build Mushroom Grove, Feed All Inhabitants, Peaceful Season Transition
  - Chaos (3): Embrace Corruption, Summon Demon, Activate Ley Line Nexus
- YAML compiles to JSON via `npm run gamedata:build` — ContentService loads automatically via all.json
- All tests pass (201/201), lint passes
- Commit: 2d5d1ee
- **Learnings for future iterations:**
  - New content types require: (1) add to ContentType union, (2) add ensureX initializer to content-initializers.ts, (3) create gamedata/[type]/ folder with YAML
  - Build script auto-discovers new folders in gamedata/ — no script changes needed
  - `reputationRewards` uses `Partial<Record<ReputationType, number>>` allowing any subset of reputation types
  - Some actions have negative reputation effects (e.g., torture chamber gives -5 harmony)

## reputation-tracking US-004: Reputation Award Integration [DONE]
- Added `ReputationAwardEvent` and `ReputationLevelUpEvent` types to `src/app/helpers/reputation.ts`
- Added `reputationAward$` and `reputationLevelUp$` RxJS observables (Subject-based, same pattern as notify.ts)
- Added `awardReputationForAction(actionId)` async function:
  - Looks up action via `getEntry<ReputationAction>(actionId)`
  - Applies all reputation rewards via `addReputation()`
  - Detects level-up transitions by comparing before/after levels
  - Emits `reputationAward$` for UI feedback
  - Emits `reputationLevelUp$` for each type that crosses a threshold
- Added `getReputationAction(actionIdOrName)` helper for direct lookups
- Added 7 unit tests covering: level-up detection at thresholds, no level-up within tier, multi-tier jumps, observable exports, action lookup
- All tests pass (208/208), lint passes
- Commit: 46db7a4
- **Learnings for future iterations:**
  - Level-up detection compares `getReputationLevel(previousPoints)` vs `getReputationLevel(newPoints)` — simple and effective
  - `updateGamestate()` is async and handles both tick-mode and direct signal updates
  - The awardReputationForAction function returns `false` if action not found or has no rewards — callers should check

## reputation-tracking US-005: Reputation Persistence [DONE - Already Implemented]
- All acceptance criteria were already met by US-002 implementation:
  - ReputationState is in GameStateWorld (state-game.ts:20)
  - indexedDbSignal persists and restores game state to/from IndexedDB
  - defaultReputationState() initializes all categories to 0 for new games
  - migrateGameState() uses `merge(defaultGameState(), state)` to handle missing fields on load
  - Serialization round-trip test exists in reputation.spec.ts
- No additional code changes required
- **Learnings for future iterations:**
  - `migrateGameState()` uses `merge()` from es-toolkit to fill missing fields from defaults — ensures forward compatibility when new state fields are added

## reputation-tracking US-006: Reputation Display Panel [DONE]
- Created `src/app/components/panel-reputation/panel-reputation.component.ts` (standalone, OnPush)
- Created template displaying all 5 reputation categories with:
  - Icon and label per category (terror/wealth/knowledge/harmony/chaos)
  - Current level name (None/Low/Medium/High/Legendary)
  - Current points value
  - Progress bar filling proportionally between current and next threshold
  - Legendary level shows full bar with shimmer animation (CSS keyframes)
- Added component to game-play page in a sidebar layout
- Fixed TypeScript errors:
  - `ReputationAction & IsContentItem` needed for `getEntry<>` calls (same pattern as RoomShape)
  - `worldgen.ts` needed all GameStateWorld fields (inhabitants, hallways, season, research, reputation)
- All tests pass (208/208), lint passes, build compiles
- Commit: 2a95b2b
- **Learnings for future iterations:**
  - Content types retrieved via `getEntry<T>` must use `T & IsContentItem` to satisfy type constraint
  - DaisyUI progress bars use classes like `progress-error`, `progress-warning`, `progress-info`, `progress-success`, `progress-secondary`
  - When adding fields to GameStateWorld, also update worldgen.ts return value
  - OKLCH color format used in DaisyUI theme variables: `oklch(var(--wa))` for warning, etc.

## reputation-tracking US-007: Reputation Level-Up Notification [DONE]
- Extended `src/app/services/notify.service.ts` to subscribe to `reputationLevelUp$`
- Added `showReputationLevelUp(event)` method displaying toast notification via ngx-toastr
- Toast shows: category name, new level, flavor text per reputation type
- Toast config: 5 second timeout, progress bar, tap-to-dismiss
- Multiple level-ups stack naturally (ngx-toastr handles stacking)
- Added REPUTATION_FLAVOR_TEXT and REPUTATION_LABELS constants for display
- All tests pass (208/208), lint passes, build compiles
- Commit: 6738405
- **Learnings for future iterations:**
  - ngx-toastr supports `tapToDismiss: true` for click-to-dismiss
  - ToastrService methods accept an optional config object as third parameter
  - Subscribing to RxJS observables in service `init()` method is the pattern for cross-cutting concerns

## biome-system US-002: Add biome field to floor data [DONE]
- Added `floors: Floor[]` and `currentFloorIndex: number` to `GameStateWorld` in state-game.ts
- Added `defaultFloor(depth)` function in defaults.ts creating floor with 'neutral' biome
- Updated `defaultGameState()` to initialize with one default floor at depth 1
- Updated `worldgen.ts` to include floors array and currentFloorIndex
- Floor biome persists automatically via game state indexedDbSignal
- All tests pass (208/208), lint passes, build compiles
- Commit: f412793
- **Learnings for future iterations:**
  - Floor type already had `biome: BiomeType` field from US-001 implementation
  - GameStateWorld uses single grid/hallways/inhabitants for current floor; the floors array provides multi-floor capability
  - `defaultFloor()` uses `rngUuid()` for floor ID generation — consistent with game ID pattern

## biome-system US-004: Implement biome query API [DONE]
- Created `src/app/helpers/floor.ts` with floor helper functions:
  - `currentFloor` computed signal — returns current floor from floors[currentFloorIndex]
  - `currentFloorBiome` computed signal — returns biome of current floor (defaults to 'neutral')
  - `allFloors` computed signal — returns all floors array
  - `getFloor(floorId)` — lookup floor by ID, returns undefined if not found
  - `getFloorBiome(floorId)` — get biome by floor ID, returns 'neutral' if floor not found
- All functions synchronous (no async loading) — data accessed directly from game state
- Created `src/app/helpers/floor.spec.ts` with 5 unit tests
- All tests pass (213/213), lint passes
- Commit: a61d287
- **Learnings for future iterations:**
  - Floor helpers follow same pattern as other helpers: computed signals + pure lookup functions
  - Using `??` operator to default to 'neutral' biome handles undefined floor case gracefully
  - The acceptance criteria asked for FloorService but helpers pattern is more consistent with codebase

## biome-system US-003: Implement biome assignment at floor creation [DONE]
- Added biome selection UI to `src/app/pages/game-setup-world/game-setup-world.component.ts` and `.html`
- UI shows all 6 biomes (volcanic, flooded, crystal, corrupted, fungal, neutral) plus a "Random" option
- Each biome option displays name, color indicator, and description
- Added `setStartingBiome(biome)`, `getStartingBiome()`, `resolveStartingBiome()` helpers to `src/app/helpers/world.ts`
- Updated `defaultFloor(depth, biome)` in `src/app/helpers/defaults.ts` to accept optional biome parameter
- Updated `worldgenGenerateWorld()` in `src/app/helpers/worldgen.ts` to use resolved starting biome
- Random selection picks from 5 non-neutral biomes with equal probability using `rngChoice()`
- Added `OnPush` change detection to game-setup-world component
- All tests pass (213/213), lint passes
- Commit: 1a80c6e
- **Learnings for future iterations:**
  - The `BIOME_DATA` constant in `@interfaces/biome` provides display data (name, description, color) for each biome
  - World setup settings like `worldSeed` and now `startingBiome` are stored in module-level signals before worldgen runs
  - The `rngChoice()` helper in `@helpers/rng` provides simple equal-probability selection from an array
  - Use `signal<BiomeType | 'random'>` to allow 'random' as a valid selection value alongside actual biome types

## biome-system US-005: Display biome information in floor UI [DONE]
- Created `src/app/components/panel-floor-selector/` with component, template, and SCSS
- Floor selector shows all floors in a list with biome icons, names, and color indicators
- Each floor entry has a colored left border matching the biome color via CSS variable `--floor-biome-color`
- Selected floor shows detail panel with biome badge, description, and effects summary
- Added `setCurrentFloorByIndex()` and `setCurrentFloorById()` to `src/app/helpers/floor.ts` for floor navigation
- Added `currentFloorIndex` computed signal for tracking selection
- Added component to game-play page sidebar alongside reputation panel
- Component uses OnPush change detection
- All tests pass (213/213), lint passes, build compiles
- Commit: 4293f1d
- **Learnings for future iterations:**
  - Use CSS custom properties (e.g., `--floor-biome-color`) on elements to pass colors from template to SCSS for dynamic styling
  - The game-play page sidebar is a flex column with gap-4; new panels stack naturally
  - Floor selection via `updateGamestate()` follows async pattern consistent with other state updates

## floor-creation-system US-002: Implement FloorService for floor state management [DONE]
- Added `getFloorByDepth(depth)` function to `src/app/helpers/floor.ts` — returns floor at given depth or undefined
- The codebase uses helper functions (not services) for state management; all PRD requirements are met via existing floor helpers:
  - `allFloors` computed signal — array of all floors
  - `currentFloor` computed signal — currently active floor
  - `setCurrentFloorById(floorId)` — switch active floor
  - `getFloorByDepth(depth)` — query floor by depth (NEW)
  - First floor auto-created via `defaultGameState()` which includes `floors: [defaultFloor()]`
- Added 5 unit tests in `src/app/helpers/floor.spec.ts` covering: depth 1/2/3 retrieval, non-existent depth, depth 0
- All tests pass (218/218), lint passes
- Commit: 7faa104
- **Learnings for future iterations:**
  - PRDs may specify "create a service" but codebase pattern uses helper functions — follow existing patterns
  - Floor helpers use same pattern as other helpers: computed signals for derived state, pure functions for lookups
  - All floor query functions already existed from prior work; only `getFloorByDepth` was missing

## floor-creation-system US-003: Implement floor creation with resource costs [DONE]
- Added `getFloorCreationCost(depth)` to `src/app/helpers/floor.ts` — returns `ResourceCost` with crystals (50 * depth) and gold (30 * depth)
- Added `canCreateFloor()` — returns `{ canCreate, reason? }` checking MAX_FLOORS limit and resource affordability
- Added `createFloor(biome?)` — creates floor at next depth, deducts costs via `payCost()`, appends to floors array via `updateGamestate()`
- Uses existing `canAfford()` and `payCost()` from resources helper for atomic resource deduction
- Uses existing `defaultFloor()` from defaults helper for floor initialization (empty 20x20 grid, no rooms/inhabitants)
- Added 13 unit tests to `src/app/helpers/floor.spec.ts` covering: cost scaling at depths 1/5/10, canCreate success/max-reached/insufficient-resources/correct-cost-calculation, createFloor success/biome/max-reached/pay-failure/resource-deduction/state-update
- Refactored existing floor test mocks to use `vi.fn()` for controllable mock return values across test cases
- All tests pass (231/231), lint passes, no new typecheck errors
- Commit: f24b6a7
- **Learnings for future iterations:**
  - When testing functions that call other helper functions (e.g., `canAfford`, `payCost`), mock the helper module rather than setting up deep gamestate — keeps tests focused on the unit under test
  - `payCost()` is async and returns boolean — must await and check return value before proceeding
  - Floor creation uses `floors.length + 1` for next depth — assumes floors are always sequential (no gaps)

## floor-creation-system US-004: Implement floor data persistence [DONE]
- Added `migrateFloors(world)` to `src/app/helpers/floor.ts` — handles migration from old save formats to multi-floor format
  - If `floors` is missing/empty in saved state, creates floor 1 from top-level `world.grid`/`world.hallways`/`world.inhabitants`
  - If `floors` exists, ensures each floor has all required fields (fills missing from `defaultFloor()`)
  - Clamps `currentFloorIndex` to valid range (0 to floors.length - 1)
- Updated `src/app/helpers/migrate.ts` to call `migrateFloors()` after the `merge()` call, explicitly setting `floors` and `currentFloorIndex` on the new state
- Floor data was already persisted via `indexedDbSignal` (GameState includes GameStateWorld which has floors[] and currentFloorIndex)
- Added 9 unit tests covering: missing floors with world data, empty world, empty floors array, preserving existing floors, filling missing floor fields, clamping out-of-bounds/negative index, preserving valid index, input immutability
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: d38e954
- **Learnings for future iterations:**
  - `merge()` from es-toolkit merges arrays by index, which can corrupt floor data — explicit migration is needed (same pattern as `migrateResources`)
  - `GameStateWorld` has both top-level grid/hallways/inhabitants AND floors[].grid/hallways/inhabitants — top-level fields are legacy; floors array is the primary source
  - Migration functions should accept `Partial<GameStateWorld>` to handle incomplete saved data gracefully

## floor-creation-system US-005: Create floor creation UI with cost display [DONE]
- Updated `src/app/components/panel-floor-selector/panel-floor-selector.component.ts`:
  - Added `SweetAlert2Module` import for confirmation dialog
  - Added computed signals: `nextFloorCost`, `canCreate`, `isMaxFloors`, `nextFloorCostLabel`
  - Added `onConfirmCreateFloor()` handler that calls `createFloor()`
- Updated `src/app/components/panel-floor-selector/panel-floor-selector.component.html`:
  - Added "Create New Floor" button below floor list with `[disabled]` binding to `canCreate().canCreate`
  - Shows cost label below button (e.g., "Cost: 100 Crystals + 60 Gold")
  - Shows error reason when creation is not possible (e.g., "Insufficient resources")
  - Shows "Maximum floors reached" text when at MAX_FLOORS
  - SweetAlert2 confirmation dialog before spending resources
- Browser verified: button renders correctly, disabled when resources insufficient, cost display accurate
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: c282f95
- **Learnings for future iterations:**
  - SweetAlert2 pattern: `[swal]="templateRef"` on button + `<swal>` element with `(confirm)` event handler
  - Computed signals returning objects (like `canCreateFloor()`) need `.canCreate` property access in templates
  - `MAX_FLOORS` must be imported from `@interfaces/floor` (not re-exported from barrel)

## research-tree-data-structure US-003: Define YAML Schema for Research Nodes [DONE]
- Created `gamedata/research/base.yml` with 3 root research nodes (one per branch: dark, arcane, engineering)
- Each node has all required fields: id (UUID), name, description, branch, cost (ResourceCost), prerequisites (string[]), unlocks (string[]), tier (number)
- Added `'research'` to `ContentType` union in `src/app/interfaces/identifiable.ts`
- Added `ensureResearch` initializer in `src/app/helpers/content-initializers.ts` with default values for all fields
- `npm run gamedata:build` compiles successfully — 3 research entries loaded
- `npm run schemas:generate` completes (pre-existing errors for other types unchanged)
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: 40b543f
- **Learnings for future iterations:**
  - Research YAML uses `prerequisites: []` and `unlocks: []` as empty arrays for root nodes
  - The `cost` field uses ResourceCost-compatible YAML (e.g., `research: 10`) — the build script passes it through as-is since the keys don't match any content type folder name
  - The build script's `rewriteDataIds` won't transform `prerequisites`/`unlocks` arrays since they use raw UUIDs, not content names

## research-tree-data-structure US-005: Define Arcane Branch Nodes [DONE]
- Created `gamedata/research/arcane.yml` with 12 Arcane branch nodes (tiers 2-6)
- Tree structure mirrors Dark branch pattern: 3 tier-2 paths branching from root, converging at tier 6
  - Flux Manipulation → Arcane Amplification → Dimensional Studies
  - Ley Line Tapping → Elemental Binding → Ley Line Mastery
  - Enchantment → Warding → Spellweave Lattice
  - Tier 5: Arcane Convergence, Planar Nexus
  - Tier 6: Grand Arcanum (capstone)
- Costs scale from 25 research + 5 flux (tier 2) to 400 research + 120 flux + 60 crystals (tier 6)
- Uses `flux` as secondary resource (arcane thematic) and `crystals` as tertiary (tier 4+)
- `npm run gamedata:build` compiles successfully — 12 arcane entries loaded (26 total research)
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: 930972d
- **Learnings for future iterations:**
  - Each research branch uses a different secondary resource: Dark=essence, Arcane=flux
  - UUID pattern per branch: dark=aa000001, arcane=aa000002, engineering=aa000003
  - Cost scaling pattern: T2=25/5, T3=50/15, T4=100/30/15, T5=200/60/30, T6=400/120/60

## research-tree-data-structure US-006: Define Engineering Branch Nodes [DONE]
- Created `gamedata/research/engineering.yml` with 12 Engineering branch nodes (tiers 2-6)
- Tree structure mirrors Dark/Arcane branch pattern: 3 tier-2 paths branching from root, converging at tier 6
  - Advanced Construction -> Master Architecture -> Siege Works
  - Trap Design -> Automated Defenses -> Mechanical Sentinels
  - Advanced Manufacturing -> Dark Forge -> Golem Assembly
  - Tier 5: War Machines, Industrial Mastery
  - Tier 6: Grand Artificer (capstone)
- Costs scale from 25 research + 5 gold (tier 2) to 400 research + 120 gold + 60 crystals (tier 6)
- Uses `gold` as secondary resource (engineering thematic) and `crystals` as tertiary (tier 4+)
- `npm run gamedata:build` compiles successfully — 12 engineering entries loaded (38 total research)
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: e271bc0
- **Learnings for future iterations:**
  - All three research branches now complete: Dark=essence, Arcane=flux, Engineering=gold
  - UUID pattern confirmed: dark=aa000001, arcane=aa000002, engineering=aa000003
  - Cost scaling pattern consistent across all branches: T2=25/5, T3=50/15, T4=100/30/15, T5=200/60/30, T6=400/120/60

## research-tree-data-structure US-007: Research Tree Validation [DONE]
- Added `validateResearchTree()` function to `scripts/gamedata-build.ts`
- Validates three things:
  1. All prerequisite references point to valid research node IDs
  2. Every branch has at least one root node (empty prerequisites)
  3. No circular dependencies (DFS-based cycle detection with path tracking)
- Runs automatically as part of `npm run gamedata:build`, between `processFiles()` and `rewriteDataIds()`
- On failure: exits with code 1 and prints clear error messages (node name, ID, and specific issue)
- On success: prints summary (node count, branch count)
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: d6493b4
- **Learnings for future iterations:**
  - Build-time validation for content types should be added to `gamedata-build.ts` between `processFiles()` and `rewriteDataIds()` — data is loaded but IDs haven't been rewritten yet
  - Research prerequisites use raw UUIDs (not name references) because the `rewriteDataIds` function only transforms keys whose names contain a content type folder name
  - The `allData['research']` array contains all research nodes from all YAML files merged together — validation operates on the combined set
  - Cycle detection uses DFS with an "in-stack" set to detect back-edges; the path array tracks the traversal for clear error messages

## room-placement-validation US-004: Visual Placement Feedback [DONE]
- Added placement preview state to `src/app/helpers/room-placement.ts`:
  - `placementPreviewShape` signal — the RoomShape being previewed (or null)
  - `placementPreviewPosition` signal — current anchor position on grid (or null)
  - `placementPreview` computed signal — returns tiles with inBounds flag, overall validity, and error messages
  - `setPlacementPreview(shape, position?)` — set both shape and optional position
  - `updatePreviewPosition(x, y)` — update position during mouse movement
  - `clearPlacementPreview()` — reset all preview state
  - `PreviewTile` type — TileOffset extended with inBounds flag
- Updated `src/app/components/grid/grid.component.ts`:
  - `previewTileSet` computed signal — builds a Set of "x,y" strings for O(1) preview tile lookup
  - `isPreviewValid(x, y)` / `isPreviewInvalid(x, y)` — check if tile is in preview and whether placement is valid/invalid
  - `onTileHover(x, y)` — updates preview position on mouseenter when a shape is being previewed
  - Escape key now clears preview first, then falls back to deselecting tile
- Updated `src/app/components/grid/grid.component.html`:
  - Added `[class.preview-valid]` and `[class.preview-invalid]` bindings
  - Added `(mouseenter)` event for hover tracking
- Updated `src/app/components/grid/grid.component.scss`:
  - `.preview-valid` — green overlay using `oklch(0.65 0.2 145)`, opacity 0.7
  - `.preview-invalid` — red overlay using `oklch(0.55 0.25 25)`, opacity 0.7
- All validation rules: if ANY tile is invalid, ALL preview tiles show red (per acceptance criteria)
- Browser verified: CSS rules compile with Angular view encapsulation, green and red colors confirmed
- All tests pass (240/240), lint passes, no new typecheck errors
- Commit: 72a6a05
- **Learnings for future iterations:**
  - Angular view encapsulation adds attribute selectors (e.g., `[_ngcontent-ng-c2974652735]`) to CSS rules — manual class additions in browser console won't match scoped styles
  - OKLCH color format works in Angular SCSS — the compiler converts to browser-compatible formats (e.g., `oklch(0.65 0.2 145)` → `rgb(17, 173, 50)`)
  - For grid tile preview, using a Set of "x,y" strings provides O(1) lookup per tile vs O(n) array scan — important for 400 tiles
  - Preview state is global (module-level signals) — consistent with selectedTile pattern in grid.ts
  - The grid component is very small on the game-play page due to flex layout — sidebar takes priority; grid needs `flex-1` or similar to grow

## room-placement-validation US-005: Placement Error Messages [DONE]
- Added `formatPlacementErrors(errors)` to `src/app/helpers/room-placement.ts` — converts technical error strings to player-friendly message (e.g., "Cannot place room: tiles are already occupied")
- Added `attemptPlacement(x, y)` — validates placement at position, returns `{ placed, errors, message }`
- Updated `src/app/components/grid/grid.component.ts`:
  - `onTileClick` now checks for active preview; calls `attemptPlacement()` and `notifyError()` if invalid
  - When preview is active, clicking bypasses normal tile selection
- Player-friendly error map converts internal messages: "Room extends beyond grid boundary" → "room extends beyond the grid boundary", "Tiles already occupied" → "tiles are already occupied"
- Multiple errors combined into single notification: "Cannot place room: error1, error2"
- Added 5 unit tests covering: empty errors, single bounds error, single overlap error, combined errors, unknown error lowercasing
- All tests pass (245/245), lint passes, no new typecheck errors
- Commit: 4258308
- **Learnings for future iterations:**
  - Avoid importing from `@helpers/notify` in helper files that are tested — it triggers circular dependency through barrel exports (notify.ts imports `isPageVisible` from `@helpers` barrel). Instead, return data from helpers and let components call `notifyError()`
  - `attemptPlacement()` returns a result object rather than calling notify directly — decouples validation from notification, avoids circular deps, and is more testable
  - The grid component handles both preview-mode clicks (attempt placement) and normal clicks (tile selection) — check `placementPreviewShape()` to determine mode

## time-system US-001: Game Time Tracking [DONE]
- Extended `GameStateClock` in `src/app/interfaces/state-game.ts` with `day`, `hour`, `minute` fields
- Created `src/app/helpers/game-time.ts` with:
  - Constants: `TICKS_PER_MINUTE = 5`, `MINUTES_PER_HOUR = 60`, `HOURS_PER_DAY = 24`
  - `GameTime` type: `{ day, hour, minute }`
  - `advanceTime(clock, numTicks)` — pure function advancing time with correct rollover
  - `advanceClockTime(clock, numTicks)` — wrapper that works with `GameStateClock`
  - Computed signals: `gameDay`, `gameHour`, `gameMinute`, `formattedGameTime` (returns "Day X - HH:MM")
- Updated `src/app/helpers/defaults.ts` — clock defaults to `day: 1, hour: 0, minute: 0`
- Updated `src/app/helpers/gameloop.ts` — calls `advanceClockTime()` during tick to advance game time
- Created `src/app/helpers/game-time.spec.ts` with 10 unit tests covering: sub-minute ticks, exact minute, multiple minutes, hour rollover, day rollover, multi-day, mixed rollover, accumulation from non-zero start, zero ticks, cascade rollover (23:59 → 00:00 next day)
- All tests pass (255/255), lint passes, no new typecheck errors
- Commit: caaf036
- **Learnings for future iterations:**
  - `TICKS_PER_MINUTE = 5` means each tick is 12 seconds of game time — at 1x speed the game loop runs ~1 tick/second, so 1 real minute ≈ 12 game minutes
  - `advanceTime()` uses integer division (`Math.floor`) for tick-to-minute conversion — fractional ticks are discarded (no sub-minute precision needed)
  - The gameloop mutates `state.clock` in-place within the `updateGamestate` callback — this is safe because it operates on the tick-local copy

## time-system US-002: Pause and Resume [DONE - Already Implemented]
- All acceptance criteria were already met by existing navbar implementation:
  - Pause button in navbar top bar (navbar.component.html:30-48) with play/pause icon toggle
  - `togglePause()` uses `setOption('gameloopPaused', ...)` (navbar.component.ts:74-77)
  - Gameloop returns early when paused: `if (isGameloopPaused()) return;` (gameloop.ts:28)
  - Visual indicator: icon swaps between `gamePauseButton`/`gamePlayButton`, tooltip changes
  - Space bar hotkey via `[hotkeys]="'SPACE'"` with `@ngneat/hotkeys`
- No additional code changes required
- **Learnings for future iterations:**
  - The navbar component already has a full pause system with pause menu, resume, and ESC key handling
  - `@ngneat/hotkeys` is used for global keyboard shortcuts (e.g., `[hotkeys]="'SPACE'"` with `isGlobal`)
  - `appRequireSetup` directive hides elements until setup is complete — the pause button is only visible in-game

## time-system US-003: Speed Controls [DONE]
- Added `GameSpeed` type (`1 | 2 | 4`) to `src/app/interfaces/state-options.ts`
- Added `gameSpeed: 1` default to `src/app/helpers/state-options.ts`
- Added `GAME_SPEEDS` constant, `gameSpeed` computed signal, and `setGameSpeed()` to `src/app/helpers/game-time.ts`
- Updated `src/app/helpers/gameloop.ts` — tick calculation now includes `getOption('gameSpeed')` multiplied with `debugTickMultiplier`
- Updated `src/app/components/navbar/navbar.component.ts` — added `gameSpeed`, `gameSpeeds`, `setSpeed()`
- Updated `src/app/components/navbar/navbar.component.html` — speed buttons (1x/2x/4x) next to pause button with:
  - `btn-primary` class on active speed, `btn-ghost` on inactive
  - Keyboard shortcuts 1/2/3 via `@ngneat/hotkeys`
  - Tooltip showing speed and shortcut
- All tests pass (255/255), lint passes, no new typecheck errors
- Commit: c46ff0b
- **Learnings for future iterations:**
  - `GameSpeed` is a union type `1 | 2 | 4`, not a generic number — keeps the type safe
  - Speed multiplies alongside `debugTickMultiplier` (both are factors in tick calculation)
  - `@ngneat/hotkeys` accepts string hotkey like `'1'`, `'2'`, `'3'` for number keys

## time-system US-004: Time Display in UI [DONE]
- Created `src/app/components/display-game-time/display-game-time.component.ts` (standalone, OnPush, inline template)
- Displays `formattedGameTime()` signal output ("Day X - HH:MM") in monospace font
- Shows `[Paused]` indicator (text-warning) when game is paused
- Shows `[Nx]` speed indicator (text-info) when speed > 1x
- Added component to navbar's `navbar-start` section with `appRequireSetup` directive
- Replaced empty disabled `<li>` with the time display
- All tests pass (255/255), lint passes, no new typecheck errors
- Commit: dd4cc5b
- **Learnings for future iterations:**
  - The navbar `navbar-start` section was empty — good place for status displays
  - Small display components with only computed signals are ideal for inline templates
  - `appRequireSetup` on the wrapper `<div>` hides the time display until game is set up

## time-system US-005: Time-Based Event Triggers [DONE]
- Created `src/app/helpers/game-events.ts` with:
  - `ScheduledEvent` type: id, triggerTime (GameTime), callback
  - `gameTimeToMinutes(time)` — converts GameTime to total minutes for comparison
  - `scheduleEvent(triggerTime, callback)` — registers one-shot event, returns id
  - `cancelEvent(id)` — removes a scheduled event
  - `processScheduledEvents(currentTime)` — fires events whose trigger time <= current time, removes fired events
  - `getScheduledEvents()` — returns read-only list for inspection
  - `clearAllEvents()` — resets all events (for testing)
- Updated `src/app/helpers/gameloop.ts` — calls `processScheduledEvents(gamestate().clock)` after advancing time
- Events don't fire when paused because the gameloop returns early when `isGameloopPaused()` is true
- Recurring events supported by re-calling `scheduleEvent()` inside the callback
- Created `src/app/helpers/game-events.spec.ts` with 15 unit tests covering: time conversion, scheduling, cancellation, firing at exact/past time, not firing before time, removal after firing, multiple events, recurring via re-registration, pause behavior
- All tests pass (270/270), lint passes, no new typecheck errors
- Commit: f68b8e5
- **Learnings for future iterations:**
  - `gameTimeToMinutes()` uses `(day - 1) * 24 * 60` because Day 1 is the first day (not Day 0)
  - During tick mode, `gamestate()` returns the tick-local copy which has the updated clock — safe to read after `updateGamestate`
  - `processScheduledEvents` separates events into toFire/remaining before executing callbacks — prevents issues if callbacks schedule new events

## production-calculation-system US-001: Base Production per Room Type [DONE]
- Created `src/app/interfaces/room.ts` with `RoomProduction`, `AdjacencyBonus`, `RoomDefinition` types
- Added `'room'` to `ContentType` union in `src/app/interfaces/identifiable.ts`
- Added `ensureRoom` initializer in `src/app/helpers/content-initializers.ts` with defaults for all fields
- Created `gamedata/room/base.yml` with 7 room types: Throne Room, Crystal Mine, Mushroom Grove, Shadow Library, Soul Well, Dark Forge, Barracks
  - Each room has UUID, name, description, shapeId, cost, production rates, requiresWorkers flag, adjacencyBonuses
  - Crystal Mine and Dark Forge have adjacency bonuses to each other (+10% and +15%)
- Added `roomTypeId` field to `PlacedRoom` type in `src/app/interfaces/room-shape.ts`
- Created `src/app/helpers/production.ts` with:
  - `getBaseProduction(roomTypeId)` — returns base production rates for a room type (or empty object if not found)
  - `getRoomDefinition(roomTypeId)` — returns full room definition (or undefined)
- Created `src/app/helpers/production.spec.ts` with 6 unit tests covering: production retrieval for producing rooms, throne room passive production, no-production rooms, non-existent room types, room definition lookup
- Fixed 3 typecheck errors in `room-shapes.spec.ts` caused by adding `roomTypeId` to `PlacedRoom`
- All tests pass (276/276), lint passes, no new typecheck errors
- Commit: dabccba

## production-calculation-system US-002: Inhabitant Efficiency Bonuses [DONE]
- Added `'inhabitant'` to `ContentType` union in `src/app/interfaces/identifiable.ts` (was missing — inhabitants couldn't load via ContentService)
- Added `ensureInhabitant` initializer in `src/app/helpers/content-initializers.ts` with defaults for all InhabitantDefinition fields
- Added to `src/app/helpers/production.ts`:
  - `InhabitantBonusResult` type: `{ bonus: number; hasWorkers: boolean }`
  - `getInhabitantDefinition(definitionId)` — looks up inhabitant content definition
  - `calculateInhabitantBonus(placedRoom, inhabitants)` — sums efficiency bonuses from assigned inhabitants
    - Each inhabitant contributes `(workerEfficiency - 1.0)` plus any `production_bonus` trait effectValues
    - Returns `hasWorkers: false` when no inhabitants are assigned to the room
- Added 8 unit tests covering: no inhabitants, inhabitants on other rooms, one with production_bonus, two identical (additive), mixed efficiency values, workerEfficiency below 1.0, non-production traits ignored, unknown definitions skipped
- All tests pass (284/284), lint passes, no new typecheck errors
- Commit: 31a66f3
- **Learnings for future iterations:**
  - The `'inhabitant'` content type was missing from ContentType union and content-initializers — the YAML compiled but entries couldn't load at runtime via ContentService
  - `workerEfficiency` of 1.0 = no bonus (0%), 1.3 = +30%, 0.7 = -30% — the formula is `(workerEfficiency - 1.0)` for the bonus contribution
  - `production_bonus` traits have effectValue that adds directly to the bonus — non-production traits (defense_bonus, trap_bonus, versatility) are ignored by calculateInhabitantBonus