# Ralph Progress Log
Started: Mon, Feb  2, 2026  2:24:22 PM
---

## resource-manager US-001: Define Resource Types and State [DONE]
- Created `src/app/interfaces/resource.ts` with `ResourceType`, `ResourceState`, and `ResourceMap` types
- Expanded `gamedata/currency/base.yml` with all 7 resource types (crystals, food, gold, flux, research, essence, corruption) including UUIDs and default max values
- Added resource export to interfaces barrel file
- All tests pass (66/66), no new typecheck errors
- Commit: 27f7f8a

## resource-manager US-002: Resource State Signal [DONE]
- Created `src/app/helpers/resources.ts` with `getResource(type)` and `allResources()` computed signal accessors
- Added `resources: ResourceMap` field to `GameStateWorld` interface in `src/app/interfaces/state-game.ts`
- Added `defaultResources()` factory to `src/app/helpers/defaults.ts` with starting values matching currency YAML (all start at 0 current)
- Updated `worldgenGenerateWorld()` in `worldgen.ts` to include default resources
- Exported resources helper from barrel file
- All tests pass (66/66), lint passes, no new typecheck errors
- Commit: 0b26811

## resource-manager US-003: Add Resources with Cap Validation [DONE]
- Added `addResource(type, amount)` function to `src/app/helpers/resources.ts`
- Returns the actual amount added after capping at max; rejects negative amounts
- Created `src/app/helpers/resources.spec.ts` with 6 unit tests covering: normal add, add exceeding cap, add zero, add negative, resource already at max, different resource types
- All tests pass (72/72), lint passes, no new typecheck errors
- Commit: a3c044c

## resource-manager US-004: Subtract Resources with Floor Validation [DONE]
- Added `ResourceCost` type to `src/app/interfaces/resource.ts` as `Partial<Record<ResourceType, number>>`
- Added `subtractResource(type, amount)` to `src/app/helpers/resources.ts` — returns false if would go below 0, no partial subtraction
- Added `canAfford(costs)` — checks if all costs in a `ResourceCost` can be paid
- Added `payCost(costs)` — atomically subtracts multiple resources (all-or-nothing via canAfford check before update)
- Added 10 unit tests covering: normal subtract, subtract more than available, subtract zero, subtract negative, exact amount, canAfford true/false/empty, payCost success, payCost failure
- All tests pass (82/82), lint passes, no new typecheck errors
- Commit: b59eb52

## resource-manager US-005: Resource Change Callbacks [DONE]
- Added `isResourceLow(type, threshold)` computed signal to `src/app/helpers/resources.ts` — returns true when current/max is below threshold percentage
- Added `isResourceFull(type)` computed signal — returns true when current equals max
- Added 8 unit tests covering: low below/above threshold, low at zero, low reactivity, full at max, full below max, full at zero, full reactivity
- All tests pass (90/90), lint passes, no new typecheck errors
- Commit: e580da0

## resource-manager US-006: Resource Save and Load [DONE]
- Added `migrateResources(saved)` to `src/app/helpers/resources.ts` — takes a partial ResourceMap from saved state and fills missing resource types with defaults
- Updated `src/app/helpers/migrate.ts` to call `migrateResources()` during game state migration, ensuring new resource types added in updates get initialized
- Added 4 unit tests covering: round-trip preservation, missing resource initialization, empty saved state, input immutability
- All tests pass (94/94), lint passes, no new typecheck errors
- **Learnings for future iterations:**
  - `migrateGameState()` uses `merge()` from es-toolkit for general field migration, but resource migration needs explicit handling since `merge()` alone doesn't guarantee the full ResourceMap shape
  - The `indexedDbSignal` in signal.ts auto-persists on `set()`/`update()` — no manual save needed for normal operations
  - Resource persistence is already wired via `GameStateWorld.resources` field added in US-002
- Commit: a78cb81

## inhabitant-data-model US-001: Define InhabitantDefinition, InhabitantStats, and InhabitantTrait types [DONE]
- Created `src/app/interfaces/inhabitant.ts` with `InhabitantTrait`, `InhabitantStats`, `InhabitantDefinition` types
- `InhabitantDefinition.cost` uses `Partial<Record<ResourceType, number>>` to match `ResourceCost`
- `InhabitantStats` includes: hp, attack, defense, speed, workerEfficiency
- Exported via barrel at `@interfaces`
- All tests pass (94/94), lint passes, no new typecheck errors
- **Learnings:** Interfaces directory uses `@interfaces/resource` alias for internal imports (lint rule: `typescript-paths/absolute-import`)
- Commit: 9e5a466

## inhabitant-data-model US-002: Define InhabitantInstance and conditional states [DONE]
- Added `InhabitantState` union type (`'normal' | 'scared' | 'hungry'`) to `src/app/interfaces/inhabitant.ts`
- Added `InhabitantInstance` type with instanceId, definitionId, name, state, assignedRoomId
- Added `inhabitants: InhabitantInstance[]` to `GameStateWorld` in `src/app/interfaces/state-game.ts`
- Updated `defaultGameState()` in `src/app/helpers/defaults.ts` to include `inhabitants: []`
- All tests pass (94/94), lint passes, no new typecheck errors
- Commit: 4c26b3b

## inhabitant-data-model US-003: Define Tier 1 inhabitants in YAML gamedata [DONE]
- Populated `gamedata/inhabitant/base.yml` with 5 Tier 1 inhabitants: Goblin, Kobold, Skeleton, Myconid, Slime
- Each entry has: UUID, name, type, tier, description, cost, stats, traits matching `InhabitantDefinition` type
- Goblin: Miner trait (+20% crystals), Kobold: Trapper trait, Skeleton: Guardian trait, Myconid: Farmer trait (+15% food), Slime: Adaptable trait
- YAML compiles via `npm run gamedata:build` — 5 entries loaded, JSON generated
- **Learnings:** `public/json/` is gitignored (generated output), only commit YAML source files. Other empty YAML files (room, decoration, pet, invader) cause non-fatal "doc is not iterable" errors in the build script — pre-existing issue.
- Commit: 176ab28

## inhabitant-data-model US-004: Implement inhabitant serialization for save/load [DONE]
- Created `src/app/helpers/inhabitants.ts` with: `allInhabitants()`, `getInhabitant()`, `addInhabitant()`, `removeInhabitant()`, `serializeInhabitants()`, `deserializeInhabitants()`
- `deserializeInhabitants()` handles missing optional fields (defaults state to 'normal', assignedRoomId to null)
- Created `src/app/helpers/inhabitants.spec.ts` with 9 unit tests covering: add, remove, get all, get by id, get nonexistent, round-trip single, round-trip multiple, missing fields, immutability
- All tests pass (103/103), lint passes, no new typecheck errors
- Commit: 639c6af

## tetromino-room-shapes US-001: Define RoomShape Type [DONE]
- Created `src/app/interfaces/room-shape.ts` with `TileOffset`, `RoomShape` types
- `RoomShape` has: id, name, tiles (array of `{x, y}` relative coordinates), width, height
- Exported via barrel at `@interfaces`
- Commit: 11d68c5

## tetromino-room-shapes US-002: Define Shape Variants in Gamedata YAML [DONE]
- Created `gamedata/roomshape/base.yml` with 6 shapes: Square 2x2, Square 3x3, Square 4x4, L-Shape, T-Shape, I-Shape
- Each shape has UUID, name, width, height, and relative tile coordinates
- Compiles via `npm run gamedata:build` — 6 entries loaded
- **Learnings:** Created separate `gamedata/roomshape/` folder rather than putting in `gamedata/room/` to avoid mixing with future room definitions (build script merges all files per folder)
- Commit: 2effb63

## tetromino-room-shapes US-003: Load Room Shapes via ContentService [DONE]
- Added `'roomshape'` to `ContentType` union in `src/app/interfaces/identifiable.ts`
- Added `ensureRoomShape` initializer in `src/app/helpers/content-initializers.ts`
- Created `src/app/helpers/room-shapes.ts` with `allRoomShapes()` and `getRoomShape()` content accessors
- **Learnings:** ContentType union must include the type for the initializer to work; `ensureContent()` is called during `unfurlAssets()` and crashes if the type is not registered
- Commit: 318a764

## tetromino-room-shapes US-004: RoomShape Helper Functions [DONE]
- Added `getAbsoluteTiles(shape, anchorX, anchorY)` — converts relative tiles to absolute grid coordinates
- Added `getShapeBounds(shape)` — returns width/height bounding box from tiles
- Added `shapeFitsInGrid(shape, anchorX, anchorY, gridSize)` — checks all tiles within grid bounds
- Created `src/app/helpers/room-shapes.spec.ts` with 16 unit tests covering all helpers
- All tests pass (119/119), lint passes
- Commit: 05e25e3

## tetromino-room-shapes US-005: Shape Serialization for Save/Load [DONE]
- Added `PlacedRoom` type to `src/app/interfaces/room-shape.ts` with: id, shapeId, anchorX, anchorY
- Added `resolveRoomShape(placedRoom)` — resolves shape from content by shapeId, returns 1x1 fallback if not found
- Added 3 tests: JSON round-trip, shapeId-not-full-data verification, fallback on missing shape
- All tests pass (122/122), lint passes
- Commit: 485e96a

## grid-system US-001 through US-005: All Stories [DONE]
- All grid-system user stories were already implemented in prior work
- US-001: `GridTile`, `GridState` types and `GRID_SIZE` constant in `src/app/interfaces/grid.ts`
- US-002: `createEmptyGrid`, `isInBounds`, `getTile`, `setTile`, `resetGrid` in `src/app/helpers/grid.ts` with 15 unit tests in `grid.spec.ts`
- US-003: `GridComponent` (OnPush) in `src/app/components/grid/` with 20x20 CSS grid layout, `.occupied`/`.selected` classes, rendered on game-play page
- US-004: `selectedTile` signal, `selectTile`/`deselectTile` helpers, Escape key handler via host binding, hover and selected CSS styles
- US-005: `GridState` in `GameStateWorld`, JSON round-trip test, `createEmptyGrid()` used in `defaults.ts` for new games
- All tests pass (122/122), lint passes
- **Learnings for future iterations:**
  - Grid helpers use pure functions (take grid as param, return new grid) rather than signal-based mutation — consistent immutable pattern
  - `GameStateWorld` already includes `grid: GridState` — no migration needed
  - Grid component uses `(document:keydown.escape)` in host bindings for keyboard shortcuts
  - CSS uses `var(--b3)`, `var(--p)`, `var(--s)`, `var(--pf)` theme variables from DaisyUI

## room-placement-validation US-001 through US-003: Validation Functions [DONE]
- Created `src/app/helpers/room-placement.ts` with three validation functions:
  - `validateBounds(shape, anchorX, anchorY, gridSize)` — returns `{valid, error?}`
  - `validateNoOverlap(shape, anchorX, anchorY, grid)` — returns `{valid, error?, conflictingTiles?}`
  - `validatePlacement(shape, anchorX, anchorY, grid)` — combined check returning `{valid, errors: string[]}`
- Created `src/app/helpers/room-placement.spec.ts` with 17 unit tests covering bounds edges, overlap scenarios, and combined validation
- All tests pass (139/139), lint passes
- Commit: cd57d94
- **Learnings for future iterations:**
  - Lint rule `typescript-paths/absolute-import` requires `@helpers/room-placement` not `./room-placement` in test imports
  - `getAbsoluteTiles()` from room-shapes.ts is reusable for converting shape-relative tiles to grid-absolute coordinates
  - Grid tiles use `[y][x]` indexing (row-major) — be careful with coordinate order

## hallway-data-structure US-001 through US-004: All Stories [DONE]
- Created `src/app/interfaces/hallway.ts` with `Hallway` and `HallwayUpgrade` types
- Added `TileOccupant` union (`'empty' | 'room' | 'hallway'`) and `hallwayId` field to `GridTile`
- Added `hallways: Hallway[]` to `GameStateWorld` in state-game.ts
- Created `src/app/helpers/hallways.ts` with: `addHallwayToGrid`, `removeHallwayFromGrid`, `isTileBlockedForHallway`, `getHallwaysBetween`, `addHallway`, `removeHallway`, `addUpgradeToHallway`, `removeUpgradeFromHallway`, `serializeHallways`, `deserializeHallways`
- Created `src/app/helpers/hallways.spec.ts` with 17 unit tests
- All tests pass (156/156), lint passes
- Commit: 3ce7f87
- **Learnings for future iterations:**
  - When adding new fields to `GridTile`, update `createEmptyGrid()` in grid.ts and fix any `toEqual` assertions in grid.spec.ts
  - Hallway helpers follow the same pure-function pattern as grid helpers (take state in, return new state)
  - `removeHallwayFromGrid` checks `hallwayId` matches before clearing — prevents accidental deletion of overlapping structures

## seasonal-cycle-system US-001 through US-005: Data Layer Complete [DONE]
- Created `src/app/interfaces/season.ts` with `Season` union, `SeasonState`, `SEASON_ORDER`, `DAYS_PER_SEASON`
- Created `src/app/helpers/season.ts` with: `advanceDay()` pure function, `advanceGameDay()` signal updater, computed signals (`currentSeason`, `dayInSeason`, `seasonProgress`, `totalSeasonCycles`), `isSeason()` helper, `getSeasonLabel()`, `seasonTransition$` RxJS observable
- Added `SeasonState` to `GameStateWorld`, `defaultSeasonState()` to defaults.ts
- Created `src/app/helpers/season.spec.ts` with 10 unit tests
- All tests pass (166/166), lint passes
- Commit: fe6e770
- **Learnings for future iterations:**
  - `advanceDay()` is a pure function for testability; `advanceGameDay()` wraps it with signal updates
  - Season transition event uses RxJS Subject (same pattern as notify.ts) — fires only on actual season change
  - `seasonProgress` computes percentage as `(dayInSeason - 1) / DAYS_PER_SEASON * 100` (day 1 = 0%, day 7 = ~85.7%)

## biome-system US-001: Define Biome Types [DONE]
- Created `src/app/interfaces/biome.ts` with `BiomeType` union (volcanic, flooded, crystal, corrupted, fungal, neutral), `Biome` type, and `BIOME_DATA` constant
- Commit: 1663833

## floor-creation-system US-001: Define Floor Data Model [DONE]
- Created `src/app/interfaces/floor.ts` with `Floor` type (id, name, depth, biome, grid, rooms, hallways, inhabitants) and `MAX_FLOORS` constant
- Floor type integrates BiomeType, GridState, PlacedRoom, Hallway, and InhabitantInstance
- Commit: 2e33c27
- **Learnings for future iterations:**
  - Floor type references all major game state subtypes — a good integration point
  - The current GameStateWorld has a single grid/hallways/inhabitants; multi-floor will require refactoring to use Floor[] instead
