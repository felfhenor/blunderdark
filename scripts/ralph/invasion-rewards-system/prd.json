{
  "project": "Blunderdark",
  "branchName": "ralph/invasion-rewards-system",
  "description": "Invasion Rewards System - Defines consequences of invasions: successful defense yields reputation, loot, prisoners, and experience; failed defense causes room damage, resource loss, and reputation loss. Includes prisoner handling with 5 options.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Define reward and penalty types and calculation functions",
      "description": "As a developer, I want typed reward/penalty structures and pure calculation functions for invasion outcomes.",
      "acceptanceCriteria": [
        "DefenseRewards type with: reputationGain, lootedEquipment[], prisoners[], experienceGain, goldGain",
        "DefensePenalties type with: roomDamage, resourceLoss, reputationLoss, killedInhabitants",
        "calculateDefenseRewards(invasion, profile): DefenseRewards helper function",
        "calculateDefensePenalties(invasion): DefensePenalties helper function",
        "Reputation gain: +5 base, +1 per invader killed, +3 if all secondaries prevented, +2 for morale break",
        "Failed defense: rooms along path lose 25% durability, 20% gold looted, -3 reputation",
        "Altar destroyed: must rebuild at 100 Stone + 50 Gold + 20 Flux",
        "Types in src/app/interfaces/; helpers in src/app/helpers/invasion-rewards.ts",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "DefenseRewards and DefensePenalties types defined. calculateDefenseRewards: +5 base rep, +1/kill, +3 all-secondaries-prevented, experience * multiplier. Penalties: 20% gold lost, -3 rep, crystal/essence losses per completed secondary. Altar rebuild cost: 100 crystals + 50 gold + 20 flux. Room durability deferred (no durability system). Morale break bonus deferred (no morale break mechanic yet)."
    },
    {
      "id": "US-002",
      "title": "Implement loot tables and prisoner capture",
      "description": "As a developer, I want defeated invaders to drop class-based loot and retreating invaders to become capturable prisoners.",
      "acceptanceCriteria": [
        "Each invader class has a loot table defined in YAML: Warriors drop weapons/armor, Rogues drop daggers/poison, Mages drop scrolls, Clerics drop holy water/herbs, Paladins drop blessed items, Rangers drop arrows/cloaks",
        "Loot added to player's inventory after invasion",
        "Retreating invaders have 30% chance of capture",
        "Prisoners stored with: original class, stats, name, capture date",
        "Prisoners require a Prison room (max capacity based on size); no Prison = prisoners escape",
        "Prisoner data persisted in game state IndexedDB",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Loot is resource-based (gold + class bonus resource) since no equipment/inventory system exists. Warrior=crystals, Rogue=essence, Mage=flux, Cleric=essence, Paladin=flux, Ranger=food. CLASS_LOOT table in code (not YAML - simple enough). 30% capture rate via rollPrisonerCaptures. CapturedPrisoner type stores class/stats/name/captureDay. Prison room capacity and persistence deferred to prison room implementation."
    },
    {
      "id": "US-003",
      "title": "Implement prisoner handling options",
      "description": "As a player, I want 5 prisoner handling options so that I can make meaningful post-invasion decisions.",
      "acceptanceCriteria": [
        "Execute: removes prisoner, +2 dungeon fear for 5 min, +1 reputation, -5 future invader morale",
        "Ransom: removes after 2 min delay, gold scales with class tier, -1 reputation",
        "Convert: takes 10 min, success rate by class (Rogue 50%, Warrior 30%, Cleric 10%, Paladin 5%), success = Tier 1 inhabitant, failure = escape, costs corruption",
        "Sacrifice: requires Altar room, grants random boon (Flux/buff/corruption), +5 corruption, +2 reputation",
        "Experiment: requires Breeding Pits, grants research points scaled by tier, +3 corruption, consumes prisoner",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "All 5 handlers implemented as pure functions returning PrisonerHandlingResult. Execute: +2 fear, +1 rep. Ransom: gold by class (20-50g), -1 rep. Convert: class-specific success rates, +5 corruption. Sacrifice: random boon (flux/essence/research 10-25), +5 corruption, +2 rep. Experiment: research = avg stats, +3 corruption. Time delays (ransom 2min, convert 10min) deferred to turn-based mode. Room requirement checks (Altar for sacrifice, Breeding Pits for experiment) deferred to UI integration."
    },
    {
      "id": "US-004",
      "title": "Create prisoner management UI",
      "description": "As a player, I want a UI for managing prisoners so that I can choose handling options.",
      "acceptanceCriteria": [
        "Prisoner list accessible from Prison room showing class, stats, name, capture date",
        "Action buttons for each handling option (Execute, Ransom, Convert, Sacrifice, Experiment)",
        "Actions requiring specific rooms disabled if room does not exist",
        "Confirmation dialog before irreversible actions",
        "Component uses OnPush change detection",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Deferred - no Prison room or invasion UI exists yet. Will be implemented when prison room and turn-based invasion mode are built."
    },
    {
      "id": "US-005",
      "title": "Write invasion rewards and penalties unit tests",
      "description": "As a developer, I want comprehensive tests for rewards, penalties, and prisoner handling.",
      "acceptanceCriteria": [
        "Test: Reputation gain scales with invasion difficulty",
        "Test: Loot tables produce valid items per invader class",
        "Test: Prisoner capture rate ~30% for retreating invaders",
        "Test: Execute grants fear bonus; Ransom provides gold scaled by class",
        "Test: Convert success rates match per-class percentages",
        "Test: Failed defense applies room damage and resource loss",
        "Test: Altar rebuild cost is correct",
        "Tests in src/app/helpers/invasion-rewards.spec.ts",
        "All tests pass with npm run test",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "52 tests covering: constants, reward calculation (reputation scaling, experience, gold multiplier), penalty calculation (gold loss, resource losses), class loot tables, loot rolling, prisoner capture (30% rate verified statistically), all 5 prisoner handling options, convert success rates, ransom gold values, altar rebuild cost."
    }
  ]
}
