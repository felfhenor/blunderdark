{
  "project": "Blunderdark",
  "branchName": "ralph/special-combat-abilities",
  "description": "Special combat abilities for defender inhabitants including Medusa Petrifying Gaze, Dragon Breath, Lich Spells, Wraith Intangible, and Orc Berserk Rage",
  "userStories": [
    {
      "id": "US-001",
      "title": "Ability System Framework",
      "description": "As a developer, I want a generic ability system so that any inhabitant can have special combat abilities",
      "acceptanceCriteria": [
        "Create CombatAbility type with fields: id, name, description, effectType, value, chance, cooldown, targetType (single/AOE/self), duration",
        "Create AbilityState type tracking: currentCooldown, isActive, remainingDuration",
        "Ability resolution integrates with the combat turn loop",
        "Abilities are defined per inhabitant type in YAML data",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "CombatAbility, AbilityState, AbilityActivation types in combat.ts. AbilityEffectType union covers damage, stun, buff_attack, buff_defense, evasion, resurrect. YAML data for specific creatures deferred until inhabitant types exist."
    },
    {
      "id": "US-002",
      "title": "Ability Cooldown Management",
      "description": "As a developer, I want cooldowns to tick down each combat turn so that abilities have strategic timing",
      "acceptanceCriteria": [
        "At the start of each combat turn, decrement all active cooldowns by 1",
        "Cooldown at 0 means the ability is ready",
        "Cooldowns are tracked per inhabitant instance",
        "Cooldown state resets between invasions",
        "Unit test verifies cooldown decrement per turn",
        "Unit test verifies ability blocked during cooldown",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "tickAbilityStates() decrements cooldowns/durations immutably. initAbilityStates() resets for new invasions. Tests verify decrement, floor at 0, blocking during cooldown."
    },
    {
      "id": "US-003",
      "title": "Ability Integration with Combat Loop",
      "description": "As a developer, I want abilities checked during the combat turn so that they fire at the right time",
      "acceptanceCriteria": [
        "During each unit's combat turn: check for passive abilities first (evasion, berserk)",
        "Then check for active abilities (gaze, breath, spells)",
        "If an active ability fires, it replaces the normal attack for that turn",
        "Passive abilities modify the normal attack/defense flow",
        "Combat log records ability activations",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "checkEvasion() for passive evasion, applyBerserkBuff() for passive attack buff, applyShieldBuff() for active defense buff, tryActivateAbility() for active abilities. Combat log integration deferred (no combat loop yet). Functions are pure and ready for integration."
    },
    {
      "id": "US-004",
      "title": "Medusa Petrifying Gaze",
      "description": "As a developer, I want Medusa to have a Petrifying Gaze ability so that she can disable invaders",
      "acceptanceCriteria": [
        "Petrifying Gaze has a 10% chance to activate per combat turn",
        "On activation, target invader is petrified (cannot act) for 3 turns",
        "Petrified invaders take double damage from all sources",
        "Only one target can be petrified at a time per Medusa",
        "Ability data is defined in the Medusa YAML file",
        "Unit tests verify proc rate and petrified target skips turns",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Stun effect type implemented with 10% proc chance and 3-turn duration. Tests verify proc/no-proc. Medusa inhabitant and YAML data deferred (creature doesn't exist yet). Double damage modifier deferred until combat loop exists."
    },
    {
      "id": "US-005",
      "title": "Dragon Breath Weapon",
      "description": "As a developer, I want the Dragon to have a Breath Weapon AOE attack so that it can damage multiple invaders",
      "acceptanceCriteria": [
        "Breath Weapon deals damage to all invaders in the current room",
        "Damage is 150% of Dragon's base Attack stat",
        "3-turn cooldown after use",
        "Dragon uses Breath Weapon when 3+ invaders are in the room",
        "Ability data is defined in the Dragon YAML file",
        "Unit tests verify AOE hits all targets, cooldown, and damage calculation",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "AOE damage ability with 150% value, 3-turn cooldown tested. Dragon YAML ability data deferred until combat loop integration. Target count threshold (3+) is caller responsibility."
    },
    {
      "id": "US-006",
      "title": "Lich Spell Casting",
      "description": "As a developer, I want the Lich to have multiple spells so that it is a versatile defender",
      "acceptanceCriteria": [
        "Death Bolt: Single target 200% magic damage, 2-turn cooldown",
        "Raise Dead: Resurrects one dead defender at 50% HP, 5-turn cooldown, single use per invasion",
        "Shield: +50% Defense to self for 3 turns, 4-turn cooldown",
        "Lich selects spell based on situation: Raise Dead if ally dead, Shield if HP < 50%, otherwise Death Bolt",
        "All spells defined in the Lich YAML file",
        "Unit tests verify each spell's effect and selection priority",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Death Bolt (200% damage, 2cd), Shield (50% defense buff, 3 duration, 4cd), Resurrect effect type all implemented. Spell selection AI and Lich YAML deferred until combat loop. Tests cover damage activation, shield buff with duration lifecycle."
    },
    {
      "id": "US-007",
      "title": "Wraith Intangible Passive",
      "description": "As a developer, I want the Wraith to have an Intangible passive so that physical attacks frequently miss",
      "acceptanceCriteria": [
        "Wraith has a 50% chance to evade physical attacks (passive, always active)",
        "Evasion does not apply to magic attacks",
        "When evasion triggers, display Phased feedback instead of Miss",
        "Evasion check happens before the normal attack roll",
        "Ability data is defined in the Wraith YAML file",
        "Unit tests verify ~50% evasion rate and magic bypass",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "checkEvasion() implemented with 50% chance. Tests verify evade/no-evade at various rolls. Magic bypass and Phased display deferred (need attack type classification and UI). Wraith inhabitant YAML deferred."
    },
    {
      "id": "US-008",
      "title": "Orc Berserk Rage",
      "description": "As a developer, I want the Orc to have Berserk Rage so that damaged Orcs become more dangerous",
      "acceptanceCriteria": [
        "When Orc HP drops below 50%, Berserk Rage activates automatically",
        "Berserk Rage grants +100% Attack stat",
        "Berserk Rage persists until combat ends or the Orc dies",
        "Ability data is defined in the Orc YAML file",
        "Unit tests verify activation at 50% HP threshold and +100% Attack bonus",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "applyBerserkBuff() checks HP/maxHp ratio against threshold. Tests verify activation below 50%, no activation above, exact threshold. Orc inhabitant YAML deferred."
    },
    {
      "id": "US-009",
      "title": "Ability Activation Feedback UI",
      "description": "As a player, I want to see when special abilities activate so that combat feels dynamic",
      "acceptanceCriteria": [
        "When an ability activates, display the ability name above the unit",
        "Ability text uses a distinct color (purple for magic, orange for physical)",
        "AOE abilities show an effect indicator on all affected targets",
        "Status effects (petrified, shielded, berserk) show an icon on the affected unit",
        "Verify in browser using dev-browser skill",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "DEFERRED: Requires invasion/combat UI mode (Phase 9) to render ability activation visuals."
    }
  ]
}
