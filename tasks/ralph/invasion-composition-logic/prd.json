{
  "project": "Blunderdark",
  "branchName": "ralph/invasion-composition-logic",
  "description": "Invasion Composition Logic - Determines which invader types appear in each invasion based on dungeon profile (corruption, wealth, knowledge), with party size scaling, seeded deterministic generation, and composition preview.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement dungeon profile calculation and invader weight mapping",
      "description": "As a developer, I want to calculate dungeon profile and map it to invader class weights so that invasion composition reflects dungeon characteristics.",
      "acceptanceCriteria": [
        "A function calculateDungeonProfile(state: GameState): DungeonProfile in helpers",
        "DungeonProfile includes: corruption (0-100), wealth (0-100), knowledge (0-100), size (room count), threatLevel",
        "Corruption derived from corruption-generating rooms and inhabitants",
        "Wealth derived from treasure rooms, vaults, gold reserves",
        "Knowledge derived from libraries, research rooms, completed research",
        "Weight mapping: High Corruption (>60) boosts Paladin+Cleric; High Wealth (>60) boosts Rogue+Warrior; High Knowledge (>60) boosts Mage+Ranger",
        "Balanced profile (all <40): equal weights for all classes",
        "Weights defined in YAML configuration (gamedata/invasion/composition-weights.yaml)",
        "Function is pure for testability",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement party size scaling and composition generation",
      "description": "As a developer, I want a seeded function that generates a specific invader party from weights and scaled size.",
      "acceptanceCriteria": [
        "Party size: 3-5 for small dungeons (1-10 rooms), 6-10 for medium (11-25), 11-15 for large (26+)",
        "Min 3, max 15 invaders",
        "generateInvasionParty(profile, seed): InvaderInstance[] uses weighted random selection",
        "Seed parameter ensures deterministic output for same inputs",
        "Party always includes at least one Warrior (frontliner)",
        "No single class exceeds 50% of the party",
        "Balanced profiles produce parties with at least 3 different classes",
        "Returns fully instantiated InvaderInstance objects",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create composition preview signal and UI",
      "description": "As a player, I want to see a preview of the likely invasion composition so that I can prepare defenses.",
      "acceptanceCriteria": [
        "A computed() signal derives likely next invasion composition from current dungeon profile",
        "Preview shows class distribution as icons and counts, plus total party size estimate",
        "Preview updates reactively when dungeon profile changes",
        "Component uses OnPush change detection and Angular Signals",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Write comprehensive composition unit tests",
      "description": "As a developer, I want tests for composition logic so that invasion generation is reliable.",
      "acceptanceCriteria": [
        "Test: High corruption profile produces >40% Paladin+Cleric",
        "Test: High wealth profile produces >40% Rogue",
        "Test: High knowledge profile produces >40% Mage",
        "Test: Balanced profile produces at least 3 different classes",
        "Test: Party size respects min (3) and max (15) bounds",
        "Test: Same seed produces identical parties",
        "Test: No single class exceeds 50% of party",
        "Tests in src/app/helpers/invasion-composition.spec.ts",
        "All tests pass with npm run test",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    }
  ]
}
