@if (labRoom(); as room) {
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4">
      <h3 class="card-title text-sm">Alchemy Lab</h3>

      <!-- Active Conversion -->
      @if (activeConversion(); as conv) {
        <div class="divider my-2 text-xs opacity-60">Active Conversion</div>
          <div class="flex flex-col gap-1 p-2 bg-base-200 rounded">
            <div class="flex items-center justify-between">
              <span class="text-xs font-semibold">{{ conv.recipeName }}</span>
              <span class="badge badge-xs badge-warning">Converting</span>
            </div>
            <span class="text-xs opacity-50">
              Output: +{{ conv.outputAmount | number:'1.0-2' }} {{ conv.outputResource }}
            </span>
            @if (conv.inputConsumed) {
              <progress
                class="progress progress-warning w-full"
                [value]="conv.percent"
                max="100"
              ></progress>
              <span class="text-xs opacity-40">{{ conv.percent | number:'1.0-2' }}%</span>
            } @else {
              <span class="text-xs text-error">Waiting for resources...</span>
            }
            <button
              class="btn btn-xs btn-ghost mt-1"
              (click)="stopConversion()"
            >Stop</button>
          </div>
      }

      <!-- Assigned Workers -->
      @if (assignedWorkers().length > 0) {
        <div class="divider my-2 text-xs opacity-60">Workers</div>
          <div class="flex flex-wrap gap-1">
            @for (w of assignedWorkers(); track w.instanceId) {
              <span class="badge badge-xs badge-outline">{{ w.defName }}</span>
            }
          </div>
      } @else {
        <p class="text-xs opacity-50 mt-2">No workers assigned.</p>
      }

      <!-- Available Recipes -->
      @if (assignedWorkers().length > 0) {
        <div class="divider my-2 text-xs opacity-60">Recipes</div>
          <div class="flex flex-col gap-2">
            @for (entry of availableRecipes(); track entry.recipe.id) {
              <div class="flex flex-col gap-1 p-2 bg-base-200 rounded">
                <div class="flex items-center justify-between">
                  <span class="text-xs font-semibold">{{ entry.recipe.name }}</span>
                  @if (entry.recipe.tier === 'advanced') {
                    <span class="badge badge-xs badge-accent">Advanced</span>
                  }
                </div>
                <span class="text-xs opacity-60">{{ entry.recipe.description }}</span>
                <span class="text-xs opacity-50">Input: {{ formatCost(entry.effectiveCost) }}</span>
                <span class="text-xs opacity-50">
                  Output: +{{ entry.recipe.outputAmount | number:'1.0-2' }} {{ entry.recipe.outputResource }}
                </span>
                <span class="text-xs opacity-50">Cycle: {{ entry.timeMinutes | number:'1.0-2' }} min</span>
                <button
                  class="btn btn-xs btn-primary mt-1"
                  [disabled]="!entry.canAfford"
                  (click)="selectRecipe(entry.recipe.id, entry.ticks)"
                >
                  @if (activeConversion()) {
                    Switch Recipe
                  } @else {
                    Start Converting
                  }
                </button>
              </div>
            }
          </div>
      }
    </div>
  </div>
}
