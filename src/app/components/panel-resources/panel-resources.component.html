@if (foodWarning(); as warning) {
  @if (!foodWarningDismissed()) {
    <div
      class="food-warning flex items-center justify-between gap-2 px-3 py-1 mb-1 rounded text-xs font-semibold"
      [class.food-warning-low]="warning.level === 'low'"
      [class.food-warning-critical]="warning.level === 'critical'"
    >
      <span>
        @if (warning.level === 'critical') {
          Food depleted! Inhabitants are starving.
        } @else {
          Low food!
          @if (warning.minutesRemaining !== undefined) {
            ~{{ warning.minutesRemaining }} game-min remaining.
          }
        }
      </span>
      <button
        class="btn btn-xs btn-ghost opacity-70"
        (click)="dismissFoodWarning()"
      >
        Dismiss
      </button>
    </div>
  }
}
<div class="resource-bar flex flex-wrap gap-2">
  @for (res of resources; track res.type) {
    <div
      class="resource-item flex-1 min-w-[120px]"
      [class]="getWarningClass(res.type)"
      [tp]="resourceTip"
      [tpDelay]="250"
      [tpClassName]="'game-tooltip'"
    >
      <div class="flex items-center justify-between mb-0.5">
        <span class="text-xs font-semibold truncate">{{ res.label }}</span>
        <span class="text-xs flex items-center gap-1">
          @if (isFull(res.type)) {
            <span class="badge badge-xs badge-warning">FULL</span>
          }
        </span>
      </div>

      <progress
        class="progress w-full h-1.5"
        [class]="res.color"
        [value]="getPercent(res.type)"
        max="100"
      ></progress>

      <div class="flex items-center justify-between mt-0.5">
        <span class="text-xs opacity-70">
          {{ getCurrent(res.type) | number: '1.0-0' }}/{{ getMax(res.type) | number: '1.0-0' }}
        </span>
        <span class="text-xs" [class]="getRateClass(res.type)">
          {{ formatRate(res.type) }}
        </span>
      </div>
    </div>

    <ng-template #resourceTip>
      <div class="font-semibold text-sm mb-1">{{ res.label }}</div>
      <div class="text-xs opacity-70 mb-2">{{ res.description }}</div>

      <div class="text-xs mb-1">
        <span class="opacity-70">Amount:</span>
        {{ getCurrent(res.type) | number: '1.0-1' }} / {{ getMax(res.type) | number: '1.0-0' }}
      </div>

      <div class="text-xs mb-2">
        <span class="opacity-70">Rate:</span>
        <span [class]="getRateClass(res.type)">{{ formatRate(res.type) }}</span>
      </div>

      @if (getBreakdown(res.type); as bd) {
        <div class="divider my-1 h-0"></div>
        <div class="text-xs font-semibold mb-1">Production Breakdown</div>
        <div class="flex flex-col gap-0.5 text-xs">
          <div class="flex justify-between">
            <span class="opacity-70">Base:</span>
            <span>{{ formatBreakdownRate(bd.base) }}/min</span>
          </div>
          @if (bd.inhabitantBonus !== 0) {
            <div class="flex justify-between">
              <span class="opacity-70">Inhabitants:</span>
              <span class="text-success">{{ formatBreakdownRate(bd.inhabitantBonus) }}/min</span>
            </div>
          }
          @if (bd.adjacencyBonus !== 0) {
            <div class="flex justify-between">
              <span class="opacity-70">Adjacency:</span>
              <span class="text-success">{{ formatBreakdownRate(bd.adjacencyBonus) }}/min</span>
            </div>
          }
          @if (bd.modifierEffect !== 0) {
            <div class="flex justify-between">
              <span class="opacity-70">Modifiers:</span>
              <span [class]="bd.modifierEffect > 0 ? 'text-success' : 'text-error'">
                {{ formatBreakdownRate(bd.modifierEffect) }}/min
              </span>
            </div>
          }
          <div class="divider my-0.5 h-0"></div>
          <div class="flex justify-between font-semibold">
            <span>Total:</span>
            <span>{{ formatBreakdownRate(bd.final) }}/min</span>
          </div>
        </div>
      }
    </ng-template>
  }

  <!-- Corruption: special display with level-based coloring -->
  <div
    class="resource-item corruption-item flex-1 min-w-[120px]"
    [tp]="corruptionTip"
    [tpDelay]="250"
    [tpClassName]="'game-tooltip'"
  >
    <div class="flex items-center justify-between mb-0.5">
      <span class="text-xs font-semibold truncate" [class]="getCorruptionColorClass(corruptionInfo().level)">
        @if (corruptionInfo().level !== 'low') {
          <span class="corruption-warning-icon">&#9888;</span>
        }
        Corruption
      </span>
      <span class="badge badge-xs" [class]="getCorruptionBadgeClass(corruptionInfo().level)">
        {{ corruptionInfo().level | uppercase }}
      </span>
    </div>

    <progress
      class="progress w-full h-1.5"
      [class]="'corruption-progress-' + corruptionInfo().level"
      [value]="corruptionInfo().value === 0 ? 0 : Math.min(100, (corruptionInfo().value / 200) * 100)"
      max="100"
    ></progress>

    <div class="flex items-center justify-between mt-0.5">
      <span class="text-xs opacity-70">
        {{ getCurrent('corruption') | number: '1.0-0' }}
      </span>
      <span class="text-xs" [class]="getRateClass('corruption')">
        {{ formatRate('corruption') }}
      </span>
    </div>
  </div>

  <ng-template #corruptionTip>
    <div class="font-semibold text-sm mb-1" [class]="getCorruptionColorClass(corruptionInfo().level)">
      Corruption
    </div>
    <div class="text-xs opacity-70 mb-2">{{ corruptionDisplay.description }}</div>

    <div class="text-xs mb-1">
      <span class="opacity-70">Amount:</span>
      {{ getCurrent('corruption') | number: '1.0-0' }}
    </div>

    <div class="text-xs mb-1">
      <span class="opacity-70">Level:</span>
      <span class="font-semibold" [class]="getCorruptionColorClass(corruptionInfo().level)">
        {{ corruptionInfo().level | uppercase }}
      </span>
    </div>

    <div class="text-xs mb-2">
      <span class="opacity-70">Rate:</span>
      <span [class]="getRateClass('corruption')">{{ formatRate('corruption') }}</span>
    </div>

    <div class="divider my-1 h-0"></div>
    <div class="text-xs opacity-80">{{ corruptionInfo().description }}</div>

    @if (getBreakdown('corruption'); as bd) {
      <div class="divider my-1 h-0"></div>
      <div class="text-xs font-semibold mb-1">Production Breakdown</div>
      <div class="flex flex-col gap-0.5 text-xs">
        <div class="flex justify-between">
          <span class="opacity-70">Base:</span>
          <span>{{ formatBreakdownRate(bd.base) }}/min</span>
        </div>
        @if (bd.inhabitantBonus !== 0) {
          <div class="flex justify-between">
            <span class="opacity-70">Inhabitants:</span>
            <span class="text-success">{{ formatBreakdownRate(bd.inhabitantBonus) }}/min</span>
          </div>
        }
        @if (bd.adjacencyBonus !== 0) {
          <div class="flex justify-between">
            <span class="opacity-70">Adjacency:</span>
            <span class="text-success">{{ formatBreakdownRate(bd.adjacencyBonus) }}/min</span>
          </div>
        }
        @if (bd.modifierEffect !== 0) {
          <div class="flex justify-between">
            <span class="opacity-70">Modifiers:</span>
            <span [class]="bd.modifierEffect > 0 ? 'text-success' : 'text-error'">
              {{ formatBreakdownRate(bd.modifierEffect) }}/min
            </span>
          </div>
        }
        <div class="divider my-0.5 h-0"></div>
        <div class="flex justify-between font-semibold">
          <span>Total:</span>
          <span>{{ formatBreakdownRate(bd.final) }}/min</span>
        </div>
      </div>
    }
  </ng-template>
</div>

@if (activeTimeModifiers().resourceModifiers.length > 0 || activeTimeModifiers().creatureModifiers.length > 0) {
  <div class="time-modifiers flex flex-wrap items-center gap-1 mt-1">
    <span class="text-xs opacity-60 font-semibold">{{ getPhaseLabel() }}:</span>
    @for (mod of activeTimeModifiers().resourceModifiers; track mod.resourceType + mod.phase) {
      <span
        class="badge badge-xs"
        [class.badge-success]="isPositiveModifier(mod)"
        [class.badge-error]="!isPositiveModifier(mod)"
        [tp]="mod.description"
      >
        {{ formatMultiplier(mod) }} {{ getResourceLabel(mod.resourceType) }}
      </span>
    }
    @for (mod of activeTimeModifiers().creatureModifiers; track mod.creatureType + mod.phase) {
      <span
        class="badge badge-xs"
        [class.badge-success]="isPositiveModifier(mod)"
        [class.badge-error]="!isPositiveModifier(mod)"
        [tp]="mod.description"
      >
        {{ formatMultiplier(mod) }} {{ mod.creatureType }}
      </span>
    }
  </div>
}
