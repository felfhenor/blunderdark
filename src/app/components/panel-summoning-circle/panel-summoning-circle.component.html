@if (summoningRoom(); as room) {
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4">
      <h3 class="card-title text-sm">Summoning Circle</h3>

      <!-- Active Summoning Job -->
      @if (summoningProgress(); as sp) {
        <div class="mt-2">
          <div class="flex items-center justify-between">
            <span class="text-xs">Summoning: {{ sp.recipeName }}</span>
            <span class="badge badge-xs badge-primary">In Progress</span>
          </div>
          <progress
            class="progress progress-primary w-full mt-1"
            [value]="sp.percent"
            max="100"
          ></progress>
          <span class="text-xs opacity-40">{{ sp.percent | number:'1.0-2' }}%</span>
        </div>
      }

      <!-- Assigned Inhabitants -->
      @if (assignedInhabitants().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Summoners:</h4>
          <div class="flex flex-wrap gap-1">
            @for (inh of assignedInhabitants(); track inh.instanceId) {
              <span class="badge badge-xs badge-outline">{{ inh.defName }}</span>
            }
          </div>
        </div>
      } @else {
        <p class="text-xs opacity-50 mt-2">No summoner assigned.</p>
      }

      <!-- Available Recipes -->
      @if (availableRecipes().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Summon Recipes:</h4>
          <div class="flex flex-col gap-2">
            @for (entry of availableRecipes(); track entry.recipe.id) {
              <div class="flex flex-col gap-1 p-2 bg-base-200 rounded">
                <div class="flex items-center justify-between">
                  <span class="text-xs font-semibold">{{ entry.recipe.name }}</span>
                  <span class="badge badge-xs" [class.badge-info]="entry.recipe.summonType === 'permanent'" [class.badge-warning]="entry.recipe.summonType === 'temporary'">{{ entry.recipe.summonType }}</span>
                </div>
                <span class="text-xs opacity-60">{{ entry.recipe.description }}</span>
                <span class="text-xs opacity-50">Cost: {{ formatCost(entry.recipe.cost) }}</span>
                <span class="text-xs opacity-50">Time: {{ entry.timeMinutes | number:'1.0-2' }} min</span>
                @if (formatStatBonuses(entry.statBonuses); as bonusStr) {
                  @if (bonusStr) {
                    <span class="text-xs text-success">Bonuses: {{ bonusStr }}</span>
                  }
                }
                @if (entry.duration) {
                  <span class="text-xs opacity-50">Duration: {{ entry.duration | number:'1.0-2' }} ticks</span>
                }
                <button
                  class="btn btn-xs btn-primary mt-1"
                  [disabled]="!entry.canAfford"
                  (click)="startSummoning(entry.recipe.id, entry.ticks, entry.recipe.cost)"
                >
                  @if (entry.canAfford) {
                    Start Summoning
                  } @else {
                    Not enough resources
                  }
                </button>
              </div>
            }
          </div>
        </div>
      }

      <!-- Active Temporary Summons -->
      @if (temporaryInhabitants().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Active Temporary Summons:</h4>
          <div class="flex flex-col gap-1">
            @for (temp of temporaryInhabitants(); track temp.name) {
              <div class="flex items-center justify-between">
                <span class="text-xs">{{ temp.name }}</span>
                <span class="text-xs opacity-50">{{ temp.minutesRemaining | number:'1.0-2' }} min left</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
}

<!-- Summon Result Modal -->
<app-modal [(visible)]="showSummonResult">
  <span title>Summoning Complete</span>
  <div body>
    @if (lastSummonResult(); as result) {
      <div class="text-center">
        <p class="text-lg font-semibold">{{ result.name }}</p>
        @if (result.summonType === 'permanent') {
          <p class="text-success mt-2">A permanent creature has joined your dungeon!</p>
        } @else {
          <p class="text-warning mt-2">A temporary helper has been summoned. It will fade over time.</p>
        }
      </div>
    }
  </div>
  <div actions>
    <button class="btn btn-sm" (click)="showSummonResult.set(false)">Close</button>
  </div>
</app-modal>
