@if (selectedRoom(); as room) {
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4">
      <h3 class="card-title text-sm">{{ room.name }}</h3>

      @if (roomProduction().length > 0) {
        <div class="flex flex-wrap gap-2 mt-1">
          @for (prod of roomProduction(); track prod.type) {
            <span class="badge badge-sm badge-outline">
              +{{ prod.perMinute.toFixed(1) }} {{ prod.type }}/min
            </span>
          }
        </div>
      }

      @if (efficiencyBreakdown(); as eff) {
        <div class="mt-1">
          <div class="flex items-center gap-1">
            <span class="text-xs opacity-50">Efficiency:</span>
            <span
              class="text-xs font-semibold"
              [class.text-success]="eff.totalMultiplier > 1.0"
              [class.text-error]="eff.totalMultiplier < 1.0"
            >{{ (eff.totalMultiplier * 100).toFixed(0) }}%</span>
          </div>
          <div class="text-xs opacity-40 ml-2">Base: {{ (eff.baseEfficiency * 100).toFixed(0) }}%</div>
          @for (contrib of eff.inhabitantBonuses; track contrib.instanceId) {
            <div class="text-xs ml-2">
              <span>{{ contrib.name }}:</span>
              <span
                [class.text-success]="contrib.totalBonus > 0"
                [class.text-error]="contrib.totalBonus < 0"
              >
                {{ contrib.totalBonus >= 0 ? '+' : '' }}{{ (contrib.totalBonus * 100).toFixed(0) }}%
              </span>
              @for (tb of contrib.traitBonuses; track tb.traitName) {
                @if (tb.applies) {
                  <span class="opacity-50">({{ tb.traitName }})</span>
                }
              }
            </div>
          }
        </div>
      }

      @if (room.maxInhabitants !== 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">
            Inhabitants:
            <span class="font-mono">
              {{ inhabitantCount() }}/{{ room.maxInhabitants === -1 ? 'Unlimited' : room.maxInhabitants }}
            </span>
          </h4>

          @if (assignedInhabitants().length > 0) {
            <div class="flex flex-col gap-1 mb-2">
              @for (inh of assignedInhabitants(); track inh.instance.instanceId) {
                <div class="flex items-center justify-between gap-2">
                  <span class="text-xs">{{ inh.name }}</span>
                  <button
                    class="btn btn-xs btn-outline btn-error"
                    (click)="onUnassignInhabitant(inh.instance.instanceId)"
                  >
                    Remove
                  </button>
                </div>
              }
            </div>
          }

          @if (room.maxInhabitants === -1 || inhabitantCount() < room.maxInhabitants) {
            @if (eligibleUnassigned().length > 0) {
              <div class="flex flex-col gap-1">
                <span class="text-xs opacity-50">Assign:</span>
                @for (inh of eligibleUnassigned(); track inh.instance.instanceId) {
                  <button
                    class="btn btn-xs btn-outline btn-success"
                    (click)="onAssignInhabitant(inh.instance.instanceId)"
                  >
                    {{ inh.name }}
                  </button>
                }
              </div>
            } @else if (assignedInhabitants().length === 0) {
              <p class="text-xs opacity-50">No eligible inhabitants available.</p>
            }
          }
        </div>
      }

      @if (adjacentUnconnected().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Connect to:</h4>
          <div class="flex flex-col gap-1">
            @for (adj of adjacentUnconnected(); track adj.id) {
              <button
                class="btn btn-xs btn-outline btn-success"
                (click)="onConnect(adj.id)"
              >
                {{ adj.name }}
              </button>
            }
          </div>
        </div>
      }

      @if (activeConnections().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Connected:</h4>
          <div class="flex flex-col gap-1">
            @for (conn of activeConnections(); track conn.connectionId) {
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs">{{ conn.otherRoomName }}</span>
                <button
                  class="btn btn-xs btn-outline btn-error"
                  (click)="onDisconnect(conn.connectionId)"
                >
                  Disconnect
                </button>
              </div>
            }
          </div>
        </div>
      }

      @if (adjacentUnconnected().length === 0 && activeConnections().length === 0) {
        <p class="text-xs opacity-50 mt-1">No adjacent rooms to connect.</p>
      }

      <div class="divider my-1"></div>

      @if (canRemoveRoom()) {
        <button
          class="btn btn-sm btn-error btn-outline w-full"
          [swal]="removeSwal"
        >
          Remove Room
        </button>

        <swal
          #removeSwal
          [title]="removalSwalTitle()"
          [text]="removalSwalText()"
          icon="warning"
          confirmButtonText="Yes, demolish"
          cancelButtonText="No, cancel"
          [showCancelButton]="true"
          (confirm)="onConfirmRemoval()"
        ></swal>
      } @else {
        <button
          class="btn btn-sm btn-outline w-full btn-disabled"
          disabled
          title="Altar cannot be removed"
        >
          Remove Room
        </button>
      }
    </div>
  </div>
}
