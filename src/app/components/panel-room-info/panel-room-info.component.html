@if (selectedRoom(); as room) {
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-4">
      <h3 class="card-title text-sm">{{ room.name }}</h3>

      @if (roomProduction().length > 0) {
        <div class="flex flex-wrap gap-2 mt-1">
          @for (prod of roomProduction(); track prod.type) {
            <span class="badge badge-sm badge-outline">
              +{{ prod.perMinute.toFixed(1) }} {{ prod.type }}/min
            </span>
          }
        </div>
      }

      @if (efficiencyBreakdown(); as eff) {
        <div class="mt-1">
          <div class="flex items-center gap-1">
            <span class="text-xs opacity-50">Efficiency:</span>
            <span
              class="text-xs font-semibold"
              [class.text-success]="eff.totalMultiplier > 1.0"
              [class.text-error]="eff.totalMultiplier < 1.0"
            >{{ (eff.totalMultiplier * 100).toFixed(0) }}%</span>
          </div>
          <div class="text-xs opacity-40 ml-2">Base: {{ (eff.baseEfficiency * 100).toFixed(0) }}%</div>
          @for (contrib of eff.inhabitantBonuses; track contrib.instanceId) {
            <div class="text-xs ml-2">
              <span>{{ contrib.name }}:</span>
              <span
                [class.text-success]="contrib.totalBonus > 0"
                [class.text-error]="contrib.totalBonus < 0"
              >
                {{ contrib.totalBonus >= 0 ? '+' : '' }}{{ (contrib.totalBonus * 100).toFixed(0) }}%
              </span>
              @for (tb of contrib.traitBonuses; track tb.traitName) {
                @if (tb.applies) {
                  <span class="opacity-50">({{ tb.traitName }})</span>
                }
              }
            </div>
          }
        </div>
      }

      @if (fearBreakdown(); as fear) {
        <div class="mt-2">
          <div class="flex items-center gap-2">
            <span class="text-xs opacity-50">Fear:</span>
            <span class="text-xs font-semibold" [class]="fearLabelClass()">{{ fearLabel() }}</span>
          </div>
          <progress
            class="progress w-full"
            [class]="fearProgressClass()"
            [value]="fear.effectiveFear"
            [max]="fearMax"
          ></progress>
          @if (fear.inhabitantModifier !== 0 || fear.upgradeAdjustment !== 0 || fear.altarAuraReduction !== 0 || fear.propagatedFear !== 0) {
            <div class="text-xs opacity-40 ml-2">Base: {{ fear.baseFear }}</div>
            @if (fear.inhabitantModifier !== 0) {
              <div class="text-xs ml-2" [class.text-error]="fear.inhabitantModifier > 0" [class.text-success]="fear.inhabitantModifier < 0">
                Inhabitants: {{ fear.inhabitantModifier > 0 ? '+' : '' }}{{ fear.inhabitantModifier }}
              </div>
            }
            @if (fear.upgradeAdjustment !== 0) {
              <div class="text-xs ml-2" [class.text-error]="fear.upgradeAdjustment > 0" [class.text-success]="fear.upgradeAdjustment < 0">
                Upgrades: {{ fear.upgradeAdjustment > 0 ? '+' : '' }}{{ fear.upgradeAdjustment }}
              </div>
            }
            @if (fear.altarAuraReduction !== 0) {
              <div class="text-xs ml-2 text-success">
                Altar Aura: -{{ fear.altarAuraReduction }}
              </div>
            }
            @if (fear.propagatedFear !== 0) {
              <div class="text-xs ml-2 text-error">
                Adjacent: +{{ fear.propagatedFear }}
              </div>
              @for (source of fear.propagationSources; track source.sourceRoomId) {
                <div class="text-xs ml-4 opacity-50">
                  +{{ source.amount }} from {{ source.sourceRoomName }}
                </div>
              }
            }
          }
        </div>
      }

      <!-- Feature Slots -->
      @if (featureSlots().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Features:</h4>
          <div class="flex flex-col gap-1">
            @for (slot of featureSlots(); track slot.index) {
              @if (slot.feature) {
                <div class="flex items-center justify-between gap-2">
                  <span
                    class="text-xs truncate"
                    [tp]="slot.feature.description"
                    [tpDelay]="250"
                  >{{ slot.feature.name }}</span>
                  <button
                    class="btn btn-xs btn-outline btn-error"
                    [swal]="featureRemoveSwal"
                    (click)="featureRemoveSlotIndex = slot.index"
                  >
                    Remove
                  </button>
                </div>
              } @else {
                <button
                  class="btn btn-xs btn-outline btn-accent w-full"
                  (click)="onOpenFeatureSelect(slot.index)"
                >
                  + Add Feature
                </button>
              }
            }
          </div>
        </div>
      }

      <!-- Resource Converter -->
      @if (hasResourceConverter()) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Resource Converter:</h4>
          <div class="flex items-center gap-2">
            <select
              class="select select-xs select-bordered flex-1"
              [value]="convertedOutputResource() ?? ''"
              (change)="onSetConvertedResource($any($event.target).value)"
            >
              <option value="">No conversion</option>
              @for (res of availableConversionResources(); track res) {
                <option [value]="res">{{ res }}</option>
              }
            </select>
            <span class="text-xs opacity-50">{{ (converterEfficiency() * 100).toFixed(0) }}% eff.</span>
          </div>
        </div>
      }

      @if (room.maxInhabitants !== 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">
            Inhabitants:
            <span class="font-mono">
              {{ inhabitantCount() }}/{{ room.maxInhabitants === -1 ? 'Unlimited' : room.maxInhabitants }}
            </span>
          </h4>

          @if (assignedInhabitants().length > 0) {
            <div class="flex flex-col gap-1 mb-2">
              @for (inh of assignedInhabitants(); track inh.instance.instanceId) {
                <div class="flex items-center justify-between gap-2">
                  <span class="text-xs flex items-center gap-1">
                    {{ inh.name }}
                    <app-hunger-indicator [inhabitantId]="inh.instance.instanceId" />
                  </span>
                  <button
                    class="btn btn-xs btn-outline btn-error"
                    (click)="onUnassignInhabitant(inh.instance.instanceId)"
                  >
                    Remove
                  </button>
                </div>
              }
            </div>
          }

          @if (room.maxInhabitants === -1 || inhabitantCount() < room.maxInhabitants) {
            @if (eligibleUnassigned().length > 0) {
              <div class="flex flex-col gap-1">
                <span class="text-xs opacity-50">Assign:</span>
                @for (inh of eligibleUnassigned(); track inh.instance.instanceId) {
                  <button
                    class="btn btn-xs btn-outline btn-success"
                    (click)="onAssignInhabitant(inh.instance.instanceId)"
                  >
                    {{ inh.name }}
                  </button>
                }
              </div>
            } @else if (assignedInhabitants().length === 0) {
              <p class="text-xs opacity-50">No eligible inhabitants available.</p>
            }
          }
        </div>
      }

      @if (adjacentUnconnected().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Connect to:</h4>
          <div class="flex flex-col gap-1">
            @for (adj of adjacentUnconnected(); track adj.id) {
              <button
                class="btn btn-xs btn-outline btn-success"
                (click)="onConnect(adj.id)"
              >
                {{ adj.name }}
              </button>
            }
          </div>
        </div>
      }

      @if (activeConnections().length > 0) {
        <div class="mt-2">
          <h4 class="text-xs font-semibold opacity-70 mb-1">Connected:</h4>
          <div class="flex flex-col gap-1">
            @for (conn of activeConnections(); track conn.connectionId) {
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs">{{ conn.otherRoomName }}</span>
                <button
                  class="btn btn-xs btn-outline btn-error"
                  (click)="onDisconnect(conn.connectionId)"
                >
                  Disconnect
                </button>
              </div>
            }
          </div>
        </div>
      }

      @if (adjacentUnconnected().length === 0 && activeConnections().length === 0) {
        <p class="text-xs opacity-50 mt-1">No adjacent rooms to connect.</p>
      }

      <div class="divider my-1"></div>

      @if (canRemoveRoom()) {
        <button
          class="btn btn-sm btn-error btn-outline w-full"
          [swal]="removeSwal"
        >
          Remove Room
        </button>

        <swal
          #removeSwal
          [title]="removalSwalTitle()"
          [text]="removalSwalText()"
          icon="warning"
          confirmButtonText="Yes, demolish"
          cancelButtonText="No, cancel"
          [showCancelButton]="true"
          (confirm)="onConfirmRemoval()"
        ></swal>
      } @else {
        <button
          class="btn btn-sm btn-outline w-full btn-disabled"
          disabled
          [tp]="'Altar cannot be removed'"
        >
          Remove Room
        </button>
      }
    </div>
  </div>

  <!-- Feature removal confirmation -->
  <swal
    #featureRemoveSwal
    title="Remove Feature?"
    text="This feature will be destroyed and cannot be recovered."
    icon="warning"
    confirmButtonText="Yes, remove"
    cancelButtonText="No, keep"
    [showCancelButton]="true"
    (confirm)="onRemoveFeature(featureRemoveSlotIndex)"
  ></swal>

  <!-- Feature selection modal -->
  <app-modal [(visible)]="showFeatureSelect">
    <span title>Select Feature</span>
    <div body>
      @if (availableFeatures().length === 0) {
        <p class="text-sm opacity-50">No features available.</p>
      } @else {
        <div class="flex flex-col gap-2 max-h-64 overflow-y-auto">
          @for (entry of availableFeatures(); track entry.feature.id) {
            <div
              class="card card-compact bg-base-200"
              [class.opacity-50]="!entry.affordable"
            >
              <div class="card-body p-3">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1 min-w-0">
                    <h5 class="text-sm font-semibold">{{ entry.feature.name }}</h5>
                    <p class="text-xs opacity-70">{{ entry.feature.description }}</p>
                    <div class="flex flex-wrap gap-1 mt-1">
                      @for (bonus of entry.feature.bonuses; track bonus.description) {
                        <span class="badge badge-xs badge-success badge-outline">{{ bonus.description }}</span>
                      }
                    </div>
                    <div class="flex flex-wrap gap-1 mt-1">
                      @for (cost of entry.costEntries; track cost.type) {
                        <span
                          class="badge badge-xs"
                          [class.badge-error]="!entry.affordable"
                          [class.badge-outline]="entry.affordable"
                        >{{ cost.amount }} {{ cost.type }}</span>
                      }
                    </div>
                  </div>
                  <button
                    class="btn btn-xs btn-primary"
                    [disabled]="!entry.affordable"
                    (click)="onAttachFeature(entry.feature.id)"
                  >
                    Attach
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
    <div actions>
      <button class="btn btn-sm" (click)="showFeatureSelect.set(false)">Cancel</button>
    </div>
  </app-modal>
}
