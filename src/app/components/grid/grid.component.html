<div
  class="grid-viewport"
  #viewport
  (wheel)="onWheel($event)"
  (mousedown)="onCameraMouseDown($event)"
  (mousemove)="onCameraMouseMove($event)"
  (mouseup)="onCameraMouseUp()"
  (mouseleave)="onCameraMouseUp()"
>
  <div
    class="grid-container"
    [class.camera-animating]="cameraIsAnimating()"
    [class.hallway-mode]="isHallwayMode()"
    [class.stair-mode]="isStairMode()"
    [class.elevator-mode]="isElevatorMode()"
    [class.portal-mode]="isPortalMode()"
    [class]="'corruption-' + corruptionLevel()"
    [style.transform]="cameraTransform()"
    (mouseleave)="onGridLeave()"
    (contextmenu)="onRightClick($event)"
  >
    @for (row of grid(); track rowIdx; let rowIdx = $index) {
      @for (tile of row; track colIdx; let colIdx = $index) {
        <div
          class="grid-tile"
          [class.occupied]="tile.occupied"
          [class.room-tile]="tile.roomId"
          [class.stair-tile]="tile.stairId"
          [class.stair-up]="getStairInfo(colIdx, rowIdx)?.direction === 'up'"
          [class.stair-down]="getStairInfo(colIdx, rowIdx)?.direction === 'down'"
          [class.elevator-tile]="tile.elevatorId"
          [class.portal-tile]="tile.portalId"
          [class.selected]="isSelected(colIdx, rowIdx)"
          [class.preview-valid]="isPreviewValid(colIdx, rowIdx)"
          [class.preview-invalid]="isPreviewInvalid(colIdx, rowIdx)"
          [class.hallway-start]="isHallwayStartTile(colIdx, rowIdx)"
          [class.hallway-end]="isHallwayEndTile(colIdx, rowIdx)"
          [class.hallway-path]="isHallwayPathTile(colIdx, rowIdx)"
          [style.--room-color]="getRoomColor(tile.roomId)"
          [style.--room-border-color]="getRoomBorderColor(colIdx, rowIdx)"
          [class]="getRoomBorderClasses(colIdx, rowIdx)"
          (click)="onTileClick(colIdx, rowIdx)"
          (mouseenter)="onTileHover(colIdx, rowIdx)"
        >
          @if (isRoomAnchor(colIdx, rowIdx, tile.roomId)) {
            <span class="room-label" [style.--room-center-offset]="getRoomLabelOffset(tile.roomId)">{{ getRoomName(tile.roomId) }}@if (getAssignmentInfo(tile.roomId); as info) {<span class="assignment-inline" [class.status-full]="info.status === 'full'" [class.status-partial]="info.status === 'partial'" [class.status-empty]="info.status === 'empty'"> ({{ info.current | number:'1.0-2' }}/{{ info.max === -1 ? '\u221E' : info.max }})</span>}</span>
            <app-fear-indicator class="fear-grid-badge" [style.--room-center-offset]="getRoomLabelOffset(tile.roomId)" [roomId]="tile.roomId!" />
            @if (getFeatureInfo(tile.roomId); as fInfo) {
              <span
                class="feature-indicator"
                [style.--room-center-offset]="getRoomLabelOffset(tile.roomId)"
                [tp]="fInfo.names.join(', ')"
                [tpDelay]="250"
              >&#9670;{{ fInfo.occupied | number:'1.0-2' }}/{{ fInfo.total | number:'1.0-2' }}</span>
            }
          }
          @if (getDoorways(colIdx, rowIdx); as dirs) {
            @if (dirs.has('top')) {
              <div class="doorway doorway-top"></div>
            }
            @if (dirs.has('right')) {
              <div class="doorway doorway-right"></div>
            }
            @if (dirs.has('bottom')) {
              <div class="doorway doorway-bottom"></div>
            }
            @if (dirs.has('left')) {
              <div class="doorway doorway-left"></div>
            }
          }
          @if (getHallwayDoorways(colIdx, rowIdx); as hdirs) {
            @if (hdirs.has('top')) {
              <div class="doorway doorway-top"></div>
            }
            @if (hdirs.has('right')) {
              <div class="doorway doorway-right"></div>
            }
            @if (hdirs.has('bottom')) {
              <div class="doorway doorway-bottom"></div>
            }
            @if (hdirs.has('left')) {
              <div class="doorway doorway-left"></div>
            }
          }
          @if (getStairInfo(colIdx, rowIdx); as stairInfo) {
            <div class="stair-indicator">
              <span class="stair-arrow">{{ stairInfo.direction === 'up' ? '&#9650;' : '&#9660;' }}</span>
              <span class="stair-label">F{{ stairInfo.connectsToDepth | number:'1.0-2' }}</span>
            </div>
          }
          @if (getElevatorInfo(colIdx, rowIdx); as elevInfo) {
            <div class="elevator-indicator">
              <span class="elevator-icon">&#8661;</span>
              <span class="elevator-label">F{{ elevInfo.connectsToFloors.join(',') }}</span>
            </div>
          }
          @if (getPortalInfo(colIdx, rowIdx); as portalInfo) {
            <div class="portal-indicator">
              <span class="portal-icon">&#10022;</span>
              <span class="portal-label">F{{ portalInfo.connectsToDepth | number:'1.0-2' }}</span>
            </div>
          }
        </div>
      }
    }
  </div>

  <button
    class="camera-reset-btn btn btn-xs btn-ghost"
    (click)="onResetCamera()"
    title="Reset Camera (Home)"
  >
    &#8962; Reset
  </button>
</div>
